<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel Financeiro - Controle Mensal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: { extend: {} }
    }
  </script>

  <style>
    /* Tabelas auto para se ajustar ao conteúdo */
    table { table-layout: auto; width: 100%; }
    table th, table td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-date { width: auto; min-width: 90px; }
    .col-desc { width: auto; min-width: 160px; }
    .col-cat { width: auto; min-width: 120px; }
    .col-payment { width: auto; min-width: 100px; }
    .col-value { width: auto; min-width: 100px; text-align: right; }
    .col-status { width: auto; min-width: 80px; text-align: center; }
    .col-action { width: auto; min-width: 80px; text-align: center; }
    
    /* Sorting styles */
    .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px !important; }
    .sortable:hover { background-color: rgba(99, 102, 241, 0.1); }
    .sortable::after { content: '⇅'; position: absolute; right: 8px; opacity: 0.3; font-size: 10px; }
    .sortable.asc::after { content: '↑'; opacity: 1; color: rgb(99, 102, 241); }
    .sortable.desc::after { content: '↓'; opacity: 1; color: rgb(99, 102, 241); }
    
    /* Filter styles */
    .table-filter.active { 
      border: 2px solid rgb(99, 102, 241) !important; 
      background-color: rgb(238, 242, 255);
      padding-left: 24px !important;
    }
    .filter-indicator {
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      color: rgb(99, 102, 241);
      font-size: 10px;
      pointer-events: none;
    }
    .filter-cell { position: relative; }
    .clear-filters-btn {
      display: none;
      margin-left: auto;
    }
    .clear-filters-btn.visible {
      display: inline-flex;
    }
    
    /* Sidebar collapse styles */
    aside {
      transition: width 0.3s ease, transform 0.3s ease;
    }
    aside.collapsed {
      width: 64px;
    }
    aside.collapsed .sidebar-text {
      display: none;
    }
    aside.collapsed .sidebar-icon {
      margin: 0 auto;
    }
    aside.collapsed .month-number {
      display: block !important;
    }
    .month-number {
      display: none;
    }
    .sidebar-toggle {
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .sidebar-toggle.collapsed {
      transform: rotate(180deg);
    }
    
    /* Toast notification styles */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      min-width: 320px;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast.success {
      border-left: 4px solid #10b981;
    }
    .toast.error {
      border-left: 4px solid #ef4444;
    }
    .toast.warning {
      border-left: 4px solid #f59e0b;
    }
    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .toast-icon.success { color: #10b981; }
    .toast-icon.error { color: #ef4444; }
    .toast-icon.warning { color: #f59e0b; }
    .toast-content {
      flex: 1;
    }
    .toast-title {
      font-weight: 600;
      font-size: 14px;
      color: #111827;
      margin-bottom: 2px;
    }
    .toast-message {
      font-size: 12px;
      color: #6b7280;
    }
    .toast-close {
      cursor: pointer;
      color: #9ca3af;
      font-size: 16px;
      padding: 4px;
      transition: color 0.2s;
    }
    .toast-close:hover {
      color: #4b5563;
    }
    
    /* Mobile card view styles */
    @media (max-width: 767px) {
      /* Hide table view on mobile */
      .table-container table {
        display: none;
      }
      
      /* Show card view on mobile */
      .card-view {
        display: block !important;
      }
      
      /* Card styles */
      .transaction-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }
      
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f3f4f6;
      }
      
      .card-title {
        font-weight: 600;
        font-size: 14px;
        color: #111827;
        flex: 1;
      }
      
      .card-value {
        font-weight: 700;
        font-size: 16px;
        color: #111827;
        white-space: nowrap;
        margin-left: 12px;
      }
      
      .card-body {
        display: grid;
        gap: 8px;
      }
      
      .card-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }
      
      .card-label {
        color: #6b7280;
        font-weight: 500;
      }
      
      .card-value-text {
        color: #111827;
        text-align: right;
      }
      
      .card-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
      }
      
      .card-actions button {
        flex: 1;
        font-size: 12px;
        padding: 6px 12px;
      }
      
      /* Hide clear filters button text on mobile, show only icon */
      .clear-filters-btn span.btn-text {
        display: none;
      }
    }
    
    /* Desktop: hide card view by default */
    @media (min-width: 768px) {
      .card-view {
        display: none !important;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 flex text-gray-900">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="w-64 bg-gray-900 text-gray-100 flex flex-col">
    <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-indigo-500 flex items-center justify-center sidebar-icon">
          <i class="fa-solid fa-wallet text-white text-sm"></i>
        </div>
        <div class="sidebar-text">
          <p class="font-semibold text-sm">Painel Financeiro</p>
          <p class="text-xs text-gray-400">Controle mensal</p>
        </div>
      </div>
      <button id="sidebarToggle" class="sidebar-toggle w-6 h-6 rounded flex items-center justify-center hover:bg-gray-800 transition">
        <i class="fa-solid fa-chevron-left text-xs text-gray-400"></i>
      </button>
    </div>

    <div class="px-4 pt-4 pb-2">
      <button
        id="btnAnnual"
        class="w-full flex items-center justify-between text-sm px-3 py-2 rounded-lg border border-gray-700 bg-gray-800 hover:bg-gray-700 transition"
      >
        <span class="flex items-center gap-2">
          <i class="fa-solid fa-chart-pie text-indigo-400 sidebar-icon"></i>
          <span class="sidebar-text">Visão Anual</span>
        </span>
        <i class="fa-solid fa-chevron-right text-xs text-gray-400 sidebar-text"></i>
      </button>
    </div>

    <div class="px-4 py-3">
      <p class="text-xs uppercase tracking-wide text-gray-500 mb-2 sidebar-text">Meses do ano</p>
      <div class="space-y-1 text-sm">
        <button data-month-index="0" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Janeiro</span><span class="text-[10px] text-gray-500 sidebar-text">01</span><span class="month-number text-xs text-gray-400 mx-auto">01</span>
        </button>
        <button data-month-index="1" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Fevereiro</span><span class="text-[10px] text-gray-500 sidebar-text">02</span><span class="month-number text-xs text-gray-400 mx-auto">02</span>
        </button>
        <button data-month-index="2" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Março</span><span class="text-[10px] text-gray-500 sidebar-text">03</span><span class="month-number text-xs text-gray-400 mx-auto">03</span>
        </button>
        <button data-month-index="3" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Abril</span><span class="text-[10px] text-gray-500 sidebar-text">04</span><span class="month-number text-xs text-gray-400 mx-auto">04</span>
        </button>
        <button data-month-index="4" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Maio</span><span class="text-[10px] text-gray-500 sidebar-text">05</span><span class="month-number text-xs text-gray-400 mx-auto">05</span>
        </button>
        <button data-month-index="5" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Junho</span><span class="text-[10px] text-gray-500 sidebar-text">06</span><span class="month-number text-xs text-gray-400 mx-auto">06</span>
        </button>
        <button data-month-index="6" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Julho</span><span class="text-[10px] text-gray-500 sidebar-text">07</span><span class="month-number text-xs text-gray-400 mx-auto">07</span>
        </button>
        <button data-month-index="7" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Agosto</span><span class="text-[10px] text-gray-500 sidebar-text">08</span><span class="month-number text-xs text-gray-400 mx-auto">08</span>
        </button>
        <button data-month-index="8" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Setembro</span><span class="text-[10px] text-gray-500 sidebar-text">09</span><span class="month-number text-xs text-gray-400 mx-auto">09</span>
        </button>
        <button data-month-index="9" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Outubro</span><span class="text-[10px] text-gray-500 sidebar-text">10</span><span class="month-number text-xs text-gray-400 mx-auto">10</span>
        </button>
        <button data-month-index="10" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Novembro</span><span class="text-[10px] text-gray-500 sidebar-text">11</span><span class="month-number text-xs text-gray-400 mx-auto">11</span>
        </button>
        <button data-month-index="11" class="month-btn w-full flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-800 transition">
          <span class="sidebar-text">Dezembro</span><span class="text-[10px] text-gray-500 sidebar-text">12</span><span class="month-number text-xs text-gray-400 mx-auto">12</span>
        </button>
      </div>
    </div>

    <div class="mt-auto px-4 py-4 border-t border-gray-800 text-xs text-gray-500">
      <p class="sidebar-text">Dados salvos em <span class="font-semibold text-gray-300">Firestore</span>.</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-4 lg:p-8 space-y-6 overflow-x-hidden">
    <!-- Header com filtro de ano -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
          <i class="fa-solid fa-gauge-high text-indigo-500"></i>
          <span id="viewTitle">Resumo de Janeiro</span>
        </h1>
        <p class="text-sm text-gray-500" id="viewSubtitle">
          Totais calculados com base nas transações do mês selecionado.
        </p>
      </div>
      <div class="flex flex-col items-start md:items-end gap-2">
        <div class="flex flex-col items-start md:items-end">
          <label for="yearFilter" class="text-[11px] font-medium text-gray-500 uppercase tracking-wide">
            Ano
          </label>
          <select
            id="yearFilter"
            class="mt-1 w-40 rounded-lg border border-gray-200 px-2 py-1 text-xs bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <!-- opções via JS -->
          </select>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Receita</div>
          <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span> Investimento</div>
          <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-amber-400"></span> Fixa</div>
          <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-orange-500"></span> Variável</div>
        </div>
      </div>
    </header>

    <!-- VISÃO MENSAL -->
    <div id="monthlyView" class="space-y-6">
      <!-- 1) RESUMO CARDS (COM SALDO LÍQUIDO) -->
      <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
        <!-- Receitas -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col p-4 border-l-4 border-l-emerald-500">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Receitas</p>
              <p class="text-sm text-gray-900 font-semibold" id="totalReceitas">R$ 0,00</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center">
              <i class="fa-solid fa-arrow-trend-up text-emerald-500"></i>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-0.5" id="deltaReceitas"></p>
          <p class="text-xs text-gray-500 mt-1">Entradas no período selecionado.</p>
        </div>

        <!-- Investimentos -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col p-4 border-l-4 border-l-blue-500">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Investimentos</p>
              <p class="text-sm text-gray-900 font-semibold" id="totalInvestimentos">R$ 0,00</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
              <i class="fa-solid fa-vault text-blue-500"></i>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-0.5" id="deltaInvestimentos"></p>
          <p class="text-xs text-gray-500 mt-1">Aportes e aplicações.</p>
        </div>

        <!-- Despesas Fixas -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col p-4 border-l-4 border-l-amber-400">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Despesas Fixas</p>
              <p class="text-sm text-gray-900 font-semibold" id="totalFixas">R$ 0,00</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center">
              <i class="fa-solid fa-house-chimney text-amber-400"></i>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-0.5" id="deltaFixas"></p>
          <p class="text-xs text-gray-500 mt-1">Contas recorrentes.</p>
        </div>

        <!-- Despesas Variáveis -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col p-4 border-l-4 border-l-orange-500">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Despesas Variáveis</p>
              <p class="text-sm text-gray-900 font-semibold" id="totalVariaveis">R$ 0,00</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa-solid fa-cart-shopping text-orange-500"></i>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-0.5" id="deltaVariaveis"></p>
          <p class="text-xs text-gray-500 mt-1">Compras e gastos eventuais.</p>
        </div>

        <!-- Saldo Líquido -->
        <div id="cardSaldo" class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col p-4 border-l-4 border-l-slate-500">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Saldo Líquido</p>
              <p class="text-sm text-gray-900 font-semibold" id="totalSaldo">R$ 0,00</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center">
              <i class="fa-solid fa-scale-balanced text-slate-600"></i>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-0.5" id="deltaSaldo"></p>
          <p class="text-xs text-gray-500 mt-1">Receitas - Despesas - Investimentos.</p>
        </div>
      </section>

      <!-- 2) CARTÕES (mantido, com cores laterais) -->
      <section class="space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <i class="fa-solid fa-credit-card text-indigo-500"></i>
            Faturas dos Cartões
          </h2>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between">
            <div class="flex items-center justify-between mb-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Total de Faturas</p>
                <p class="text-lg font-semibold text-gray-900" id="totalFaturas">R$ 0,00</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center">
                <i class="fa-solid fa-file-invoice-dollar text-rose-500"></i>
              </div>
            </div>
            <p class="text-xs text-gray-500">
              Soma de todas as despesas no cartão no período selecionado.
            </p>
          </div>

          <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-3">
            <!-- Cartões mantidos: adicionei border-left colorido para cada cartão -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col gap-1 border-l-4 border-l-sky-500" id="cardContainer-caixa">
              <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">Caixa</p>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] bg-sky-100 text-sky-700 px-1.5 py-0.5 rounded-full font-medium" id="cardCount-caixa">0</span>
                  <i class="fa-solid fa-credit-card text-sky-600 text-sm"></i>
                </div>
              </div>
              <p class="text-sm font-semibold text-gray-900" id="cardCaixa">R$ 0,00</p>
              <button
                class="card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium"
                data-card="caixa"
              ></button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col gap-1 border-l-4 border-l-orange-500" id="cardContainer-inter_debora">
              <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">Inter (Débora)</p>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded-full font-medium" id="cardCount-inter_debora">0</span>
                  <i class="fa-solid fa-credit-card text-orange-500 text-sm"></i>
                </div>
              </div>
              <p class="text-sm font-semibold text-gray-900" id="cardInterD">R$ 0,00</p>
              <button
                class="card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium"
                data-card="inter_debora"
              ></button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col gap-1 border-l-4 border-l-orange-400" id="cardContainer-inter_cristiano">
              <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">Inter (Cristiano)</p>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded-full font-medium" id="cardCount-inter_cristiano">0</span>
                  <i class="fa-solid fa-credit-card text-orange-500 text-sm"></i>
                </div>
              </div>
              <p class="text-sm font-semibold text-gray-900" id="cardInterC">R$ 0,00</p>
              <button
                class="card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium"
                data-card="inter_cristiano"
              ></button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col gap-1 border-l-4 border-l-violet-600" id="cardContainer-nubank">
              <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">Nubank</p>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] bg-violet-100 text-violet-700 px-1.5 py-0.5 rounded-full font-medium" id="cardCount-nubank">0</span>
                  <i class="fa-solid fa-credit-card text-purple-600 text-sm"></i>
                </div>
              </div>
              <p class="text-sm font-semibold text-gray-900" id="cardNubank">R$ 0,00</p>
              <button
                class="card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium"
                data-card="nubank"
              ></button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col gap-1 border-l-4 border-l-slate-700" id="cardContainer-c6">
              <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">C6 Bank</p>
                <div class="flex items-center gap-1">
                  <span class="text-[10px] bg-slate-100 text-slate-700 px-1.5 py-0.5 rounded-full font-medium" id="cardCount-c6">0</span>
                  <i class="fa-solid fa-credit-card text-gray-900 text-sm"></i>
                </div>
              </div>
              <p class="text-sm font-semibold text-gray-900" id="cardC6">R$ 0,00</p>
              <button
                class="card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium"
                data-card="c6"
              ></button>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) FORMULÁRIOS DE LANÇAMENTO -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Card Nova Receita -->
        <form id="formReceita" class="bg-white rounded-xl shadow-sm border border-emerald-200 p-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                <span class="inline-flex w-6 h-6 rounded-full bg-emerald-50 items-center justify-center">
                  <i class="fa-solid fa-arrow-trend-up text-emerald-500 text-xs"></i>
                </span>
                Nova Receita
              </h2>
              <p class="text-xs text-gray-500">Entrada de fundos no período selecionado.</p>
            </div>
          </div>

          <div class="space-y-2 text-xs">
            <div class="space-y-1">
              <label for="recDesc" class="font-medium text-gray-700">Descrição</label>
              <input id="recDesc" type="text" required
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                placeholder="Ex: Salário, Freelancer..." />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1">
                <label for="recValor" class="font-medium text-gray-700">Valor (R$)</label>
                <input id="recValor" type="number" step="0.01" min="0" required
                  class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                  placeholder="0,00" />
              </div>
              <div class="space-y-1">
                <label for="recData" class="font-medium text-gray-700">Data</label>
                <input id="recData" type="date" required
                  class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
              </div>
            </div>
            <div class="space-y-1">
              <label for="recCategoria" class="font-medium text-gray-700">Categoria da Receita</label>
              <select id="recCategoria" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <!-- Opções expandidas -->
                <option value="salario">Salário</option>
                <option value="freelancer">Freelancer / Extra</option>
                <option value="decimo">13º / Bônus</option>
                <option value="reembolso">Reembolso</option>
                <option value="aluguéis">Aluguéis</option>
                <option value="juros_dividendos">Juros / Dividendos</option>
                <option value="outros">Outros</option>
              </select>
            </div>
          </div>

          <div class="pt-2 flex justify-end">
            <button type="submit"
              class="inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
              <i class="fa-solid fa-plus text-[11px]"></i>
              Lançar Receita
            </button>
          </div>
        </form>

        <!-- Card Nova Despesa / Investimento -->
        <form id="formDespesa" class="bg-white rounded-xl shadow-sm border border-orange-200 p-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                <span class="inline-flex w-6 h-6 rounded-full bg-orange-50 items-center justify-center">
                  <i class="fa-solid fa-arrow-trend-down text-orange-500 text-xs"></i>
                </span>
                Nova Despesa / Investimento
              </h2>
              <p class="text-xs text-gray-500">Saída de fundos, incluindo despesas e aportes.</p>
            </div>
          </div>

          <div class="space-y-2 text-xs">
            <div class="space-y-1">
              <label for="despDesc" class="font-medium text-gray-700">Descrição</label>
              <input id="despDesc" type="text" required
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                placeholder="Ex: Aluguel, Supermercado, Aporte..." />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1">
                <label for="despValor" class="font-medium text-gray-700">Valor (R$)</label>
                <input id="despValor" type="number" step="0.01" required
                  class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="0,00" />
              </div>
              <div class="space-y-1">
                <label for="despData" class="font-medium text-gray-700">Data</label>
                <input id="despData" type="date" required
                  class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
              </div>
            </div>
            <div class="space-y-1">
              <label for="despCategoria" class="font-medium text-gray-700">Tipo (Fixa / Variável / Investimento)</label>
              <select id="despCategoria" required
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="fixa">Despesa Fixa</option>
                <option value="variavel">Despesa Variável</option>
                <option value="investimento">Investimento</option>
              </select>
            </div>
            <div class="space-y-1">
              <label for="despSubCategoria" class="font-medium text-gray-700">Categoria detalhada</label>
              <select id="despSubCategoria" required
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <!-- opções via JS -->
              </select>
            </div>

            <div class="flex items-center gap-2 text-xs text-gray-700">
              <input id="despTambemLazer" type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
              <label for="despTambemLazer" class="select-none">Somar também como Lazer</label>
            </div>

            <!-- Nova: Forma de Pagamento -->
            <div class="space-y-2">
              <label for="despFormaPagamento" class="font-medium text-gray-700">Forma de Pagamento</label>
              <select id="despFormaPagamento" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="debito_pix">Débito / PIX</option>
                <option value="cartao">Cartão de Crédito</option>
                <option value="boleto">Boleto</option>
                <option value="dinheiro">Dinheiro</option>
              </select>
            </div>

            <div id="despCartaoFields" class="space-y-2 pt-1 hidden">
              <div class="space-y-1">
                <label for="despCartao" class="font-medium text-gray-700">Cartão</label>
                <select id="despCartao"
                  class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="caixa">Caixa</option>
                  <option value="inter_debora">Inter (Débora)</option>
                  <option value="inter_cristiano">Inter (Cristiano)</option>
                  <option value="nubank">Nubank</option>
                  <option value="c6">C6 Bank</option>
                </select>
              </div>
            </div>

            <div id="despParcelasWrapper" class="space-y-1 hidden">
              <label for="despParcelas" class="font-medium text-gray-700">Número de Parcelas</label>
              <input id="despParcelas" type="number" min="1" max="48" value="1"
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
              <p class="text-[11px] text-gray-400">Compras parceladas serão distribuídas automaticamente pelos meses futuros.</p>
            </div>

            <!-- Observação: checkbox 'Já aportado?' removido do formulário conforme solicitado -->
          </div>

          <div class="pt-2 flex justify-end">
            <button type="submit"
              class="inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold rounded-lg bg-orange-600 text-white hover:bg-orange-700">
              <i class="fa-solid fa-plus text-[11px]"></i>
              Lançar Saída
            </button>
          </div>
        </form>
      </section>

      <!-- 4) BARRA DE PROGRESSO DE PAGAMENTOS -->
      <section class="bg-white rounded-lg shadow-sm border border-gray-100 px-4 py-3">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-clipboard-check text-emerald-500 text-sm"></i>
            <h2 class="text-sm font-medium text-gray-700">Progresso de Pagamentos</h2>
          </div>
          <div class="flex items-center gap-3">
            <p class="text-xs text-gray-500" id="paymentCount">0 de 0 pagos</p>
            <p class="text-lg font-semibold text-gray-900" id="paymentPercentage">0%</p>
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="relative w-full h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="paymentProgressBar" class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-300 ease-out" style="width: 0%">
          </div>
        </div>
        
        <!-- Status Message -->
        <div id="paymentStatusMessage" class="mt-1.5">
          <p class="text-xs text-gray-500 text-center">Marque seus lançamentos como pagos para ver o progresso</p>
        </div>
      </section>

      <!-- 4.1) REGRA 50 / 30 / 20 -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-indigo-100 p-4 border-l-4 border-l-slate-600">
          <div class="flex items-center justify-between mb-1">
            <p class="text-xs uppercase tracking-wide text-gray-500">50% Essenciais</p>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">Fixas + Variáveis (sem lazer)</span>
          </div>
          <p id="ruleNeedsValue" class="text-lg font-semibold text-gray-900">R$ 0,00</p>
          <p id="ruleNeedsMeta" class="text-xs text-gray-500 mt-1">Limite: R$ 0,00</p>
          <p id="ruleNeedsStatus" class="text-xs font-medium text-slate-700 mt-2"></p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-indigo-100 p-4 border-l-4 border-l-purple-600">
          <div class="flex items-center justify-between mb-1">
            <p class="text-xs uppercase tracking-wide text-gray-500">30% Lazer</p>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">Subcategoria: Lazer</span>
          </div>
          <p id="ruleLeisureValue" class="text-lg font-semibold text-gray-900">R$ 0,00</p>
          <p id="ruleLeisureMeta" class="text-xs text-gray-500 mt-1">Limite: R$ 0,00</p>
          <p id="ruleLeisureStatus" class="text-xs font-medium text-purple-700 mt-2"></p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-indigo-100 p-4 border-l-4 border-l-emerald-600">
          <div class="flex items-center justify-between mb-1">
            <p class="text-xs uppercase tracking-wide text-gray-500">20% Investimentos</p>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">Aportes</span>
          </div>
          <p id="ruleInvestValue" class="text-lg font-semibold text-gray-900">R$ 0,00</p>
          <p id="ruleInvestMeta" class="text-xs text-gray-500 mt-1">Limite: R$ 0,00</p>
          <p id="ruleInvestStatus" class="text-xs font-medium text-emerald-700 mt-2"></p>
        </div>
      </section>

      <!-- 5) TABELAS DE TRANSAÇÕES (mantidas) -->
      <section class="space-y-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="px-4 py-3 border-b border-gray-100 border-l-4 border-l-emerald-500 bg-emerald-50/30 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-emerald-700">Receitas</h2>
              <p class="text-xs text-gray-500">Entradas detalhadas no período.</p>
            </div>
            <button class="clear-filters-btn px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-1" data-table="tableReceitas">
              <i class="fa-solid fa-filter-circle-xmark text-xs"></i>
              <span class="btn-text">Limpar filtros</span>
            </button>
          </div>
          <div class="overflow-x-auto table-container">
            <table id="tableReceitas" class="min-w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-xs text-gray-500 uppercase tracking-wide">
                  <th class="col-date text-left px-4 py-2 sortable" data-column="0" data-type="date">Data</th>
                  <th class="col-desc text-left px-4 py-2 sortable" data-column="1" data-type="text">Descrição</th>
                  <th class="col-cat text-left px-4 py-2 sortable" data-column="2" data-type="text">Categoria</th>
                  <th class="col-payment text-left px-4 py-2 sortable" data-column="3" data-type="text">Pagamento</th>
                  <th class="col-value text-right px-4 py-2 sortable" data-column="4" data-type="number">Valor</th>
                  <th class="col-status text-center px-4 py-2 sortable" data-column="5" data-type="text">Status</th>
                  <th class="col-action text-center px-4 py-2">Ação</th>
                </tr>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="0">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="1">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="2">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="3">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="4">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-emerald-500" data-column="5">
                  </th>
                  <th class="px-2 py-2"></th>
                </tr>
              </thead>
              <tbody id="tbodyReceitas" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
          <!-- Card view for mobile -->
          <div id="cardViewReceitas" class="card-view"></div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="px-4 py-3 border-b border-gray-100 border-l-4 border-l-orange-500 bg-orange-50/30 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-orange-700">Despesas Fixas</h2>
              <p class="text-xs text-gray-500">Contas recorrentes registradas para todos os meses.</p>
            </div>
            <button class="clear-filters-btn px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-1" data-table="tableFixas">
              <i class="fa-solid fa-filter-circle-xmark text-xs"></i>
              <span class="btn-text">Limpar filtros</span>
            </button>
          </div>
          <div class="overflow-x-auto table-container">
            <table id="tableFixas" class="min-w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-xs text-gray-500 uppercase tracking-wide">
                  <th class="col-date text-left px-4 py-2 sortable" data-column="0" data-type="date">Data</th>
                  <th class="col-desc text-left px-4 py-2 sortable" data-column="1" data-type="text">Descrição</th>
                  <th class="col-cat text-left px-4 py-2 sortable" data-column="2" data-type="text">Categoria</th>
                  <th class="col-payment text-left px-4 py-2 sortable" data-column="3" data-type="text">Pagamento</th>
                  <th class="col-value text-right px-4 py-2 sortable" data-column="4" data-type="number">Valor</th>
                  <th class="col-status text-center px-4 py-2 sortable" data-column="5" data-type="text">Status</th>
                  <th class="col-action text-center px-4 py-2">Ação</th>
                </tr>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="0">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="1">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="2">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="3">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="4">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-amber-500" data-column="5">
                  </th>
                  <th class="px-2 py-2"></th>
                </tr>
              </thead>
              <tbody id="tbodyFixas" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
          <!-- Card view for mobile -->
          <div id="cardViewFixas" class="card-view"></div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="px-4 py-3 border-b border-gray-100 border-l-4 border-l-orange-500 bg-orange-50/30 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-orange-700">Despesas Variáveis</h2>
              <p class="text-xs text-gray-500">Compras e gastos eventuais.</p>
            </div>
            <button class="clear-filters-btn px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-1" data-table="tableVariaveis">
              <i class="fa-solid fa-filter-circle-xmark text-xs"></i>
              <span class="btn-text">Limpar filtros</span>
            </button>
          </div>
          <div class="overflow-x-auto table-container">
            <table id="tableVariaveis" class="min-w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-xs text-gray-500 uppercase tracking-wide">
                  <th class="col-date text-left px-4 py-2 sortable" data-column="0" data-type="date">Data</th>
                  <th class="col-desc text-left px-4 py-2 sortable" data-column="1" data-type="text">Descrição</th>
                  <th class="col-cat text-left px-4 py-2 sortable" data-column="2" data-type="text">Categoria</th>
                  <th class="col-payment text-left px-4 py-2 sortable" data-column="3" data-type="text">Pagamento</th>
                  <th class="col-value text-right px-4 py-2 sortable" data-column="4" data-type="number">Valor</th>
                  <th class="col-status text-center px-4 py-2 sortable" data-column="5" data-type="text">Status</th>
                  <th class="col-action text-center px-4 py-2">Ação</th>
                </tr>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="0">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="1">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="2">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="3">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="4">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500" data-column="5">
                  </th>
                  <th class="px-2 py-2"></th>
                </tr>
              </thead>
              <tbody id="tbodyVariaveis" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
          <!-- Card view for mobile -->
          <div id="cardViewVariaveis" class="card-view"></div>
        </div>

        <!-- NOVA TABELA: INVESTIMENTOS MENSAL -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="px-4 py-3 border-b border-gray-100 border-l-4 border-l-blue-500 bg-blue-50/30 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-blue-700">Investimentos</h2>
              <p class="text-xs text-gray-500">Aportes do período. Você pode marcar como aportado.</p>
            </div>
            <button class="clear-filters-btn px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-1" data-table="tableInvestimentos">
              <i class="fa-solid fa-filter-circle-xmark text-xs"></i>
              <span class="btn-text">Limpar filtros</span>
            </button>
          </div>
          <div class="overflow-x-auto table-container">
            <table id="tableInvestimentos" class="min-w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-xs text-gray-500 uppercase tracking-wide">
                  <th class="col-date text-left px-4 py-2 sortable" data-column="0" data-type="date">Data</th>
                  <th class="col-desc text-left px-4 py-2 sortable" data-column="1" data-type="text">Descrição</th>
                  <th class="col-cat text-left px-4 py-2 sortable" data-column="2" data-type="text">Tipo</th>
                  <th class="col-value text-right px-4 py-2 sortable" data-column="3" data-type="number">Valor</th>
                  <th class="col-status text-center px-4 py-2 sortable" data-column="4" data-type="text">Aportado</th>
                  <th class="col-action text-center px-4 py-2">Ação</th>
                </tr>
                <tr class="bg-white border-b border-gray-100">
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" data-column="0">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" data-column="1">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" data-column="2">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" data-column="3">
                  </th>
                  <th class="px-2 py-2 filter-cell">
                    <i class="fa-solid fa-filter filter-indicator" style="display: none;"></i>
                    <input type="text" placeholder="Filtrar" class="table-filter w-full text-xs px-2 py-1 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" data-column="4">
                  </th>
                  <th class="px-2 py-2"></th>
                </tr>
              </thead>
              <tbody id="tbodyInvestimentos" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
          <!-- Card view for mobile -->
          <div id="cardViewInvestimentos" class="card-view"></div>
        </div>
      </section>
    </div>

    <!-- VISÃO ANUAL (mantida) -->
    <div id="annualView" class="space-y-4 hidden">
      <section class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h2 class="text-sm font-semibold text-gray-900">Resumo Anual</h2>
            <p class="text-xs text-gray-500">
              Visão consolidada por mês: Receitas, Despesas, Investimentos e Saldo.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="btnExportCsv"
              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-gray-200 text-[11px] font-semibold text-gray-700 hover:bg-gray-50"
            >
              <i class="fa-solid fa-file-csv text-xs"></i>
              CSV
            </button>
            <button
              id="btnExportExcel"
              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-emerald-200 text-[11px] font-semibold text-emerald-700 bg-emerald-50 hover:bg-emerald-100"
            >
              <i class="fa-solid fa-file-excel text-xs"></i>
              Excel
            </button>
          </div>
        </div>

        <!-- Cards anuais principais - Maiores e mais visuais -->
        <div class="px-4 pt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100/50 border-2 border-emerald-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-emerald-700 uppercase tracking-wide">Receitas no ano</p>
              <i class="fa-solid fa-arrow-trend-up text-emerald-600 text-lg"></i>
            </div>
            <p id="annualTotalReceitas" class="text-2xl font-bold text-emerald-900 mb-1">R$ 0,00</p>
            <div class="flex items-center gap-1 text-xs">
              <span id="annualReceitasTrend" class="font-semibold text-emerald-700"></span>
              <span class="text-emerald-600">vs média mensal</span>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-orange-50 to-orange-100/50 border-2 border-orange-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-orange-700 uppercase tracking-wide">Despesas no ano</p>
              <i class="fa-solid fa-arrow-trend-down text-orange-600 text-lg"></i>
            </div>
            <p id="annualTotalDespesas" class="text-2xl font-bold text-orange-900 mb-1">R$ 0,00</p>
            <div class="flex items-center gap-1 text-xs">
              <span id="annualDespesasTrend" class="font-semibold text-orange-700"></span>
              <span class="text-orange-600">vs média mensal</span>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-blue-50 to-blue-100/50 border-2 border-blue-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-blue-700 uppercase tracking-wide">Total investido</p>
              <i class="fa-solid fa-piggy-bank text-blue-600 text-lg"></i>
            </div>
            <p id="annualTotalInvest" class="text-2xl font-bold text-blue-900 mb-1">R$ 0,00</p>
            <div class="flex items-center gap-1 text-xs">
              <span id="annualInvestTrend" class="font-semibold text-blue-700"></span>
              <span class="text-blue-600">vs média mensal</span>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-slate-50 to-slate-100/50 border-2 border-slate-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-slate-700 uppercase tracking-wide">Saldo do ano</p>
              <i class="fa-solid fa-wallet text-slate-600 text-lg"></i>
            </div>
            <p id="annualTotalSaldo" class="text-2xl font-bold text-slate-900 mb-1">R$ 0,00</p>
            <div class="flex items-center gap-1 text-xs">
              <span id="annualSaldoTrend" class="font-semibold text-slate-700"></span>
              <span class="text-slate-600">média mensal</span>
            </div>
          </div>
        </div>

        <!-- KPIs Financeiros Adicionais -->
        <div class="px-4 pt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="bg-white border-2 border-purple-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-purple-700 uppercase tracking-wide">Taxa de Poupança</p>
              <i class="fa-solid fa-percent text-purple-600 text-lg"></i>
            </div>
            <p id="annualSavingsRate" class="text-2xl font-bold text-purple-900 mb-1">0%</p>
            <p class="text-xs text-purple-600">Receitas → Investimentos</p>
          </div>
          
          <div class="bg-white border-2 border-amber-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-amber-700 uppercase tracking-wide">Fixas vs Variáveis</p>
              <i class="fa-solid fa-balance-scale text-amber-600 text-lg"></i>
            </div>
            <p id="annualFixedVsVariable" class="text-2xl font-bold text-amber-900 mb-1">0% / 0%</p>
            <p class="text-xs text-amber-600">Proporção de despesas</p>
          </div>
          
          <div class="bg-white border-2 border-teal-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-teal-700 uppercase tracking-wide">Crescimento MoM</p>
              <i class="fa-solid fa-chart-line text-teal-600 text-lg"></i>
            </div>
            <p id="annualMoMGrowth" class="text-2xl font-bold text-teal-900 mb-1">0%</p>
            <p class="text-xs text-teal-600">Variação média mês a mês</p>
          </div>
          
          <div class="bg-white border-2 border-rose-200 rounded-xl px-4 py-4 flex flex-col shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-bold text-rose-700 uppercase tracking-wide">Ticket Médio</p>
              <i class="fa-solid fa-receipt text-rose-600 text-lg"></i>
            </div>
            <p id="annualAvgTicket" class="text-2xl font-bold text-rose-900 mb-1">R$ 0,00</p>
            <p class="text-xs text-rose-600">Gasto médio por despesa</p>
          </div>
        </div>

        <!-- Card de investimentos -->
        <div class="px-4 pt-2">
          <div class="bg-white border border-blue-100 rounded-xl px-3 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <p class="text-[11px] font-semibold text-blue-700 uppercase tracking-wide">
                Resumo de Investimentos do Ano
              </p>
              <p class="text-[11px] text-gray-500">
                Total aplicado, maior aporte único e mês com maior volume investido.
              </p>
            </div>
            <div class="flex flex-wrap gap-3 text-[11px]">
              <div>
                <p class="text-gray-500">Total investido</p>
                <p id="annualCardInvestTotal" class="font-semibold text-blue-800">R$ 0,00</p>
              </div>
              <div>
                <p class="text-gray-500">Maior aporte</p>
                <p id="annualCardInvestMax" class="font-semibold text-blue-800">R$ 0,00</p>
              </div>
              <div>
                <p class="text-gray-500">Mês de maior aporte</p>
                <p id="annualCardInvestBestMonth" class="font-semibold text-blue-800">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabela anual -->
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-100">
              <tr class="text-xs text-gray-500 uppercase tracking-wide">
                <th class="text-left px-4 py-2">Mês</th>
                <th class="text-right px-4 py-2">Receitas Totais</th>
                <th class="text-right px-4 py-2">Despesas Totais</th>
                <th class="text-right px-4 py-2">Investimentos</th>
                <th class="text-right px-4 py-2">Saldo Mensal</th>
              </tr>
            </thead>
            <tbody id="annualBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <!-- Gráficos Principais -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 p-4 border-t border-gray-100">
          <div class="h-80 flex flex-col bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide flex items-center gap-2">
                  <i class="fa-solid fa-chart-column text-indigo-600"></i>
                  Comparativo Mensal
                </h3>
                <p class="text-xs text-gray-500 mt-1">
                  Receitas x Despesas x Investimentos por mês.
                </p>
              </div>
            </div>
            <div class="flex-1">
              <canvas id="chartAnnualBars"></canvas>
            </div>
          </div>

          <div class="h-80 flex flex-col bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide flex items-center gap-2">
                  <i class="fa-solid fa-chart-area text-slate-600"></i>
                  Acumulado Anual
                </h3>
                <p class="text-xs text-gray-500 mt-1">
                  Evolução acumulada de receitas, despesas e investimentos.
                </p>
              </div>
            </div>
            <div class="flex-1">
              <canvas id="chartAnnualAccumulated"></canvas>
            </div>
          </div>

          <div class="h-80 flex flex-col bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide flex items-center gap-2">
                  <i class="fa-solid fa-chart-line text-slate-600"></i>
                  Evolução do Saldo
                </h3>
                <p class="text-xs text-gray-500 mt-1">
                  Saldo líquido de cada mês ao longo do ano.
                </p>
              </div>
            </div>
            <div class="flex-1">
              <canvas id="chartAnnualSaldo"></canvas>
            </div>
          </div>

          <div class="h-80 flex flex-col bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide flex items-center gap-2">
                  <i class="fa-solid fa-chart-pie text-orange-600"></i>
                  Distribuição de Despesas
                </h3>
                <p class="text-xs text-gray-500 mt-1">
                  Proporção entre despesas fixas e variáveis.
                </p>
              </div>
            </div>
            <div class="flex-1">
              <canvas id="chartExpenseDistribution"></canvas>
            </div>
          </div>
        </div>

        <!-- Investimentos por tipo -->
        <div class="border-t border-gray-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-blue-600"></i>
                Resumo de Investimentos por Tipo
              </h3>
              <p class="text-xs text-gray-500 mt-1">
                Baseado nas transações de investimento do período selecionado.
              </p>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
            <div class="h-80 flex flex-col bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
              <div class="flex-1">
                <canvas id="chartInvestTypes"></canvas>
              </div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr class="text-xs text-gray-500 uppercase tracking-wide">
                    <th class="text-left px-4 py-2">Tipo de Investimento</th>
                    <th class="text-right px-4 py-2">Valor Aplicado</th>
                    <th class="text-right px-4 py-2">% do Total</th>
                  </tr>
                </thead>
                <tbody id="annualInvestBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- MODAL EDIÇÃO (copiado como estava) -->
  <div id="editModal" class="fixed inset-0 z-50 hidden bg-black/40 items-center justify-center">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
            <i class="fa-solid fa-pen-to-square text-indigo-500"></i>
            Editar Lançamento
          </h2>
          <p class="text-xs text-gray-500">Atualize os dados desta transação.</p>
        </div>
        <button id="btnEditClose" class="w-7 h-7 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100">
          <i class="fa-solid fa-xmark text-xs"></i>
        </button>
      </div>

      <form id="formEdit" class="space-y-2 text-xs">
        <div class="space-y-1">
          <label for="editDesc" class="font-medium text-gray-700">Descrição</label>
          <input id="editDesc" type="text" required
            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1">
            <label for="editValor" class="font-medium text-gray-700">Valor (R$)</label>
            <input id="editValor" type="number" step="0.01" required
              class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>
          <div class="space-y-1">
            <label for="editData" class="font-medium text-gray-700">Data</label>
            <input id="editData" type="date" required
              class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>
        </div>

        <div class="space-y-1">
          <label for="editMainCategory" class="font-medium text-gray-700">Tipo</label>
          <select id="editMainCategory"
            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="receita">Receita</option>
            <option value="investimento">Investimento</option>
            <option value="fixa">Despesa Fixa</option>
            <option value="variavel">Despesa Variável</option>
          </select>
        </div>

        <div class="space-y-1">
          <label for="editSubCategory" class="font-medium text-gray-700">Categoria detalhada</label>
          <select id="editSubCategory"
            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </select>
        </div>

        <div class="flex items-center gap-2 text-xs text-gray-700">
          <input id="editTambemLazer" type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
          <label for="editTambemLazer" class="select-none">Somar também como Lazer</label>
        </div>

        <div id="editPaymentContainer" class="space-y-2 pt-1">
          <div class="flex items-center gap-2">
            <input id="editIsCartao" type="checkbox"
              class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
            <label for="editIsCartao" class="text-xs text-gray-700">Pagamento via Cartão de Crédito?</label>
          </div>

          <div id="editCartaoFields" class="space-y-2 pt-1 hidden">
            <div class="space-y-1">
              <label for="editCartao" class="font-medium text-gray-700">Cartão</label>
              <select id="editCartao"
                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="caixa">Caixa</option>
                <option value="inter_debora">Inter (Débora)</option>
                <option value="inter_cristiano">Inter (Cristiano)</option>
                <option value="nubank">Nubank</option>
                <option value="c6">C6 Bank</option>
              </select>
            </div>
          </div>
        </div>

        <div id="editParcelScope" class="hidden border-t border-gray-100 pt-2 mt-2">
          <div id="editParcelNumField" class="space-y-1 mb-3">
            <label for="editParcelas" class="font-medium text-gray-700 flex items-center gap-2">
              <i class="fa-solid fa-calculator text-indigo-600"></i>
              Número de Parcelas
            </label>
            <input id="editParcelas" type="number" min="1" max="60" step="1" value="1"
              class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
            <p class="text-xs text-gray-500 mt-1">
              <i class="fa-solid fa-info-circle"></i>
              Altere o número de parcelas para redistribuir o valor automaticamente
            </p>
          </div>
          <div id="editParcelPreview" class="hidden mt-2 border-2 border-indigo-200 rounded-lg bg-indigo-50 p-3 text-xs">
            <p class="font-semibold text-indigo-800 mb-2 flex items-center gap-2">
              <i class="fa-solid fa-receipt text-indigo-600"></i>
              Nova distribuição de parcelas:
            </p>
            <ul id="editParcelPreviewList" class="space-y-1.5 ml-1"></ul>
          </div>
          <p class="text-xs text-gray-600 mb-3 mt-3">
            Este lançamento faz parte de uma compra parcelada. O que você deseja editar?
          </p>
          <div class="flex gap-2">
            <button type="button" id="btnScopeSingle"
              class="px-4 py-2 rounded-lg text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 transition">
              Apenas esta parcela
            </button>
            <button type="button" id="btnScopeAll"
              class="px-4 py-2 rounded-lg text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 transition">
              Todas as parcelas
            </button>
          </div>
        </div>

        <div class="pt-3 flex justify-end gap-2">
          <button type="button" id="btnEditCancel"
            class="px-4 py-2 text-xs font-semibold rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">
            Cancelar
          </button>
          <button type="submit"
            class="px-4 py-2 text-xs font-semibold rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-2">
            <i class="fa-solid fa-floppy-disk text-[11px]"></i>
            Salvar alterações
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL EXCLUSÃO (novo) -->
  <div id="deleteModal" class="fixed inset-0 z-50 hidden bg-black/40 items-center justify-center">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h2 class="text-sm font-semibold text-red-700 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation text-red-600 text-lg"></i>
            Confirmar Exclusão
          </h2>
          <p id="deleteModalSubtitle" class="text-xs text-gray-600 mt-1">Selecione se quer excluir apenas este lançamento ou toda a série.</p>
        </div>
        <button id="btnDeleteClose" class="w-7 h-7 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100">
          <i class="fa-solid fa-xmark text-xs"></i>
        </button>
      </div>

      <div id="deleteScopeBlock" class="hidden border-t border-gray-100 pt-3 mt-3">
        <div id="deleteParcelPreview" class="hidden mt-2 border-2 border-red-200 rounded-lg bg-red-50 p-3 text-xs">
          <p class="font-semibold text-red-800 mb-2 flex items-center gap-2">
            <i class="fa-solid fa-receipt text-red-600"></i>
            Parcelas que serão removidas:
          </p>
          <ul id="deleteParcelPreviewList" class="space-y-1.5 ml-1"></ul>
        </div>
        <p class="text-xs text-gray-600 mb-3 mt-3">
          Este lançamento faz parte de uma compra parcelada. O que você deseja excluir?
        </p>
        <div class="flex gap-2">
          <button type="button" id="btnDeleteSingle"
            class="px-4 py-2 rounded-lg text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 transition">
            Apenas esta parcela
          </button>
          <button type="button" id="btnDeleteAll"
            class="px-4 py-2 rounded-lg text-xs font-medium bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition">
            Todas as parcelas
          </button>
        </div>
      </div>

      <div id="deleteSingleWarning" class="bg-red-50 border-2 border-red-200 rounded-lg p-3">
        <p class="text-sm text-red-800 font-semibold flex items-center gap-2">
          <i class="fa-solid fa-exclamation-circle text-red-600"></i>
          Você está prestes a excluir este lançamento.
        </p>
        <p id="deleteSingleText" class="text-xs text-red-700 mt-1 ml-6">Esta ação não pode ser desfeita.</p>
      </div>

      <div class="pt-3 flex justify-end gap-2">
        <button type="button" id="btnDeleteCancel"
          class="px-4 py-2 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
          Cancelar
        </button>
        <button type="button" id="btnDeleteConfirm"
          class="px-4 py-2 text-xs font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2">
          <i class="fa-solid fa-trash"></i>
          Confirmar exclusão
        </button>
      </div>
    </div>
  </div>

  <!-- Toast notification container -->
  <div id="toastContainer"></div>

  <!-- SCRIPT: módulo com Firebase Firestore integrado -->
  <script type="module">
    // 1) IMPORTS DO FIREBASE (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import {
        getFirestore, collection, doc, getDocs, getDocsFromServer, setDoc, deleteDoc
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // 2) SUA CONFIG (você já forneceu esta config)
    const firebaseConfig = {
      apiKey: "AIzaSyDYwlBR0DPEDs6Kq56XASppU-GSpPiCmfE",
      authDomain: "painel-financeiro-spa.firebaseapp.com",
      projectId: "painel-financeiro-spa",
      storageBucket: "painel-financeiro-spa.firebasestorage.app",
      messagingSenderId: "97230072376",
      appId: "1:97230072376:web:87842d3615419f552154cd"
    };

    // 3) Inicializa Firebase e Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    (function () {
      // KEYs (mantive para compatibilidade se quiser fallback)
      const STORAGE_KEY = 'financeDashboard_transactions';
      const INVOICE_KEY = 'financeDashboard_invoicesPaid';

      // Constantes e mapeamentos (mantidos e expandidos)
      const CATEGORY_LABELS = { receita: 'Receita', investimento: 'Investimento', fixa: 'Despesa Fixa', variavel: 'Despesa Variável' };
      const RECEITA_SUBCATEGORIES = {
        salario: 'Salário', freelancer: 'Freelancer / Extra', decimo: '13º / Bônus',
        reembolso: 'Reembolso', alugueis: 'Aluguéis', juros_dividendos: 'Juros / Dividendos', outros: 'Outros'
      };
      const DESPESA_SUBCATEGORIES = {
        moradia: 'Moradia', alimentacao: 'Alimentação', transporte: 'Transporte', lazer: 'Lazer',
        mercado: 'Mercado', restaurante: 'Restaurante', vestimenta: 'Vestuário',
        saude: 'Saúde', educacao: 'Educação', servicos: 'Serviços', manutencao: 'Manutenção', outros: 'Outros'
      };
      const INVEST_SUBCATEGORIES = {
        renda_fixa: 'Renda Fixa', renda_variavel: 'Renda Variável', tesouro: 'Tesouro Direto',
        fundos: 'Fundos de Investimento', previdencia: 'Previdência', cripto: 'Criptomoedas', imoveis: 'Imóveis', outros: 'Outros Investimentos'
      };

      const SUBCATEGORY_COLOR_CLASSES = {
        moradia: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        alimentacao: 'bg-orange-50 text-orange-700 border-orange-200',
        transporte: 'bg-sky-50 text-sky-700 border-sky-200',
        lazer: 'bg-purple-50 text-purple-700 border-purple-200',
        saude: 'bg-rose-50 text-rose-700 border-rose-200',
        educacao: 'bg-indigo-50 text-indigo-700 border-indigo-200',
        outros: 'bg-gray-50 text-gray-700 border-gray-200',
        salario: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        freelancer: 'bg-sky-50 text-sky-700 border-sky-200',
        decimo: 'bg-indigo-50 text-indigo-700 border-indigo-200',
        reembolso: 'bg-teal-50 text-teal-700 border-teal-200',
        renda_fixa: 'bg-blue-50 text-blue-700 border-blue-200',
        renda_variavel: 'bg-amber-50 text-amber-700 border-amber-200',
        tesouro: 'bg-lime-50 text-lime-700 border-lime-200',
        fundos: 'bg-cyan-50 text-cyan-700 border-cyan-200',
        previdencia: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        cripto: 'bg-purple-50 text-purple-700 border-purple-200',
        imoveis: 'bg-slate-50 text-slate-700 border-slate-200',
        servicos: 'bg-amber-50 text-amber-700 border-amber-200',
        manutencao: 'bg-rose-50 text-rose-700 border-rose-200',
        mercado: 'bg-lime-50 text-lime-700 border-lime-200',
        restaurante: 'bg-amber-50 text-amber-700 border-amber-200',
        vestimenta: 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200'
      };

      const CARD_LABELS = {
        caixa: 'Caixa',
        inter_debora: 'Inter (Débora)',
        inter_cristiano: 'Inter (Cristiano)',
        nubank: 'Nubank',
        c6: 'C6 Bank'
      };

      const MONTH_NAMES = [
        'Janeiro','Fevereiro','Março','Abril','Maio','Junho',
        'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'
      ];

      // Estado
      const state = {
        transactions: [],
        invoicesPaid: {},
        selectedMonth: new Date().getMonth(),
        selectedYear: 'all',
        editingId: null,
        editingMode: 'single',
        editingGroupId: null,
        // novos campos para exclusão
        deletingId: null,
        deletingGroupId: null,
        deletingMode: 'single' // 'single' | 'all'
      };

      // Charts placeholders
      let annualBarChart = null;
      let annualLineChart = null;
      let annualAccumulatedChart = null;
      let expenseDistributionChart = null;
      let investPieChart = null;

      // ---------- HELPERS ----------
      function buildParcelPreview(groupId) {
        if (!groupId) return [];

        return state.transactions
          .filter(t => t.groupId === groupId)
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .map(t => {
            const d = new Date(t.date);
            const labelDate = `${MONTH_NAMES[d.getMonth()]}/${d.getFullYear()}`;
            const parcelaTxt = t.parcelas > 1
              ? `(${t.parcelaIndex}/${t.parcelas})`
              : '';
            return `<span class="flex items-center gap-2"><i class="fa-regular fa-calendar text-red-600"></i> ${labelDate} — ${formatCurrency(t.value)} <span class="font-semibold">${parcelaTxt}</span></span>`;
          });
      }

      function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
      }
      function formatDate(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('pt-BR');
      }
      function generateId() {
        return 'tx_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2);
      }
      function keyInvoice(year, month, card) {
        return `${year}-${month}-${card}`;
      }
      function getYearForSelectedMonth() {
        if (state.selectedYear !== 'all') return state.selectedYear;
        const txs = state.transactions.filter((t) => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return false;
          return d.getMonth() === state.selectedMonth;
        });
        if (txs.length) {
          const d = new Date(txs[0].date);
          if (!isNaN(d.getTime())) return d.getFullYear();
        }
        return new Date().getFullYear();
      }

      const MIN_VALID_YEAR = 1900;
      const MAX_VALID_YEAR = 3000;

      // Normalizes different date formats coming from Firestore/localStorage
      function isFirestoreTimestamp(value) {
        return (
          typeof value === 'object' &&
          value !== null &&
          typeof value.toDate === 'function' &&
          typeof value.toMillis === 'function'
        );
      }

      function isValidDateNumber(value) {
        if (typeof value !== 'number') return false;
        const parsed = new Date(value);
        const year = parsed.getUTCFullYear();
        return !isNaN(parsed.getTime()) && year >= MIN_VALID_YEAR && year <= MAX_VALID_YEAR;
      }

      function normalizeDateValue(value) {
        if (!value) return new Date().toISOString();
        if (typeof value === 'string') return value;
        if (value instanceof Date) return value.toISOString();
        if (isFirestoreTimestamp(value)) {
          try {
            return value.toDate().toISOString();
          } catch (e) {
            console.error('Timestamp conversion failed:', e);
            return new Date().toISOString();
          }
        }
        if (typeof value === 'number') {
          if (isValidDateNumber(value)) {
            return new Date(value).toISOString();
          }
          console.warn('normalizeDateValue: numeric date out of expected range, using current date', value);
          return new Date().toISOString();
        }
        console.warn('normalizeDateValue: unexpected date format, using current date', value);
        return new Date().toISOString();
      }

      // ---------- FIRESTORE PERSISTENCE ----------
      async function loadTransactions() {
        try {
          const colRef = collection(db, "transactions");
          const snap = await fetchCollectionPreferServer(colRef);
          const result = [];
          snap.forEach(docSnap => {
            const data = docSnap.data();
            result.push({
              id: docSnap.id,
              description: data.description || '',
              value: Number(data.value) || 0,
              date: normalizeDateValue(data.date),
              category: data.category || 'variavel',
              subCategory: data.subCategory || null,
              isCreditCard: !!data.isCreditCard,
              card: data.card || null,
              parcelas: data.parcelas || 1,
              parcelaIndex: data.parcelaIndex || 1,
              paymentMethod: data.paymentMethod || null,
              groupId: data.groupId || null,
              paid: !!data.paid,
            aportado: !!data.aportado,
              extraLazer: !!data.extraLazer
            });
          });
          state.transactions = result;
          updateLocalBackup();
        } catch (e) {
          console.error("Erro ao carregar transactions do Firestore", e);
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed)) {
                state.transactions = parsed.map(t => ({
                  ...t,
                  date: normalizeDateValue(t.date),
                  extraLazer: !!t.extraLazer
                }));
                showToast('Sem conexão. Exibindo dados salvos localmente.', 'warning');
                return;
              }
            }
          } catch (fallbackErr) {
            console.error("Fallback localStorage para transactions falhou", fallbackErr);
          }
          state.transactions = [];
          showToast('Não foi possível atualizar do servidor. Verifique a conexão.', 'error');
        }
      }

      async function saveTransactions() {
        try {
          const colRef = collection(db, "transactions");
          // upsert: setDoc para cada transação usando t.id como doc id
          await Promise.all(state.transactions.map(t => {
            const { id, ...data } = t;
            // normalize fields (avoid undefined)
              const payload = {
                description: data.description || '',
                value: Number(data.value) || 0,
                date: data.date || new Date().toISOString(),
                category: data.category || 'variavel',
                subCategory: data.subCategory || null,
                isCreditCard: !!data.isCreditCard,
                card: data.card || null,
                parcelas: data.parcelas || 1,
                parcelaIndex: data.parcelaIndex || 1,
                paymentMethod: data.paymentMethod || null,
                groupId: data.groupId || null,
                paid: !!data.paid,
                aportado: !!data.aportado,
                extraLazer: !!data.extraLazer
              };
              return setDoc(doc(db, "transactions", id), payload);
            }));

          // opcional: também manter uma cópia em localStorage como fallback
          updateLocalBackup();
        } catch (e) {
          console.error("Erro ao salvar transactions no Firestore", e);
          updateLocalBackup();
        }
      }

      function updateLocalBackup() {
        try { 
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.transactions)); 
          return true;
        }
        catch (e) { 
          console.error("Erro ao atualizar backup local", e); 
          return false;
        }
      }

      function updateInvoicesBackup() {
        try {
          localStorage.setItem(INVOICE_KEY, JSON.stringify(state.invoicesPaid || {}));
          return true;
        } catch (e) {
          console.error("Erro ao atualizar backup local de faturas", e);
          return false;
        }
      }

      // Busca preferindo servidor; se falhar, tenta getDocs (que pode usar cache/navegador).
      async function fetchCollectionPreferServer(colRef) {
        try {
          return await getDocsFromServer(colRef);
        } catch (serverErr) {
          console.warn("getDocsFromServer falhou, tentando getDocs fallback:", serverErr);
          return await getDocs(colRef);
        }
      }

      /**
       * Executa uma operação assíncrona garantindo rollback em caso de erro.
       * @param {Function} operation Função assíncrona que realiza a operação principal.
       * @param {Function} rollback Função síncrona/assíncrona para restaurar o estado em caso de falha.
       */
      async function runWithRollback(operation, rollback) {
        try {
          await operation();
        } catch (error) {
          try { await rollback(); } catch (rollbackError) { console.error("Erro ao executar rollback", rollbackError); }
          throw error;
        }
      }

      async function loadInvoices() {
        try {
          const colRef = collection(db, "invoicesPaid");
          const snap = await fetchCollectionPreferServer(colRef);
          const result = {};
          snap.forEach(docSnap => {
            const data = docSnap.data();
            result[docSnap.id] = !!data.paid;
          });
          state.invoicesPaid = result;
          updateInvoicesBackup();
        } catch (e) {
          console.error("Erro ao carregar invoicesPaid do Firestore", e);
          try {
            const raw = localStorage.getItem(INVOICE_KEY);
            if (raw) {
              state.invoicesPaid = JSON.parse(raw);
              showToast('Sem conexão. Exibindo faturas salvas localmente.', 'warning');
              return;
            }
          } catch (fallbackErr) {
            console.error("Fallback localStorage para invoices falhou", fallbackErr);
          }
          state.invoicesPaid = {};
          showToast('Não foi possível atualizar faturas do servidor. Verifique a conexão.', 'error');
        }
      }

      async function saveInvoices() {
        try {
          const entries = Object.entries(state.invoicesPaid);
          await Promise.all(entries.map(([key, paid]) => {
            return setDoc(doc(db, "invoicesPaid", key), { paid: !!paid });
          }));
          try { localStorage.setItem(INVOICE_KEY, JSON.stringify(state.invoicesPaid)); } catch (e) {}
        } catch (e) {
          console.error("Erro ao salvar invoicesPaid no Firestore", e);
          try { localStorage.setItem(INVOICE_KEY, JSON.stringify(state.invoicesPaid)); } catch (er) {}
        }
      }

      // ---------- LÓGICA DE RENDER / CÁLCULOS ----------
      function getFilteredTransactions() {
        return state.transactions.filter((t) => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return false;
          if (state.selectedMonth !== null && d.getMonth() !== state.selectedMonth) return false;
          if (state.selectedYear !== 'all' && d.getFullYear() !== state.selectedYear) return false;
          return true;
        });
      }

      // Calcula o saldo acumulado até um mês específico (para carregar saldo anterior)
      function getCumulativeBalanceUntilMonth(monthIndex, year) {
        let cumulativeBalance = 0;
        
        // Se year é 'all', não calcula saldo anterior (muito complexo)
        if (year === 'all') return 0;
        
        const currentYear = typeof year === 'number' ? year : parseInt(year);
        
        // Obter todas as transações ordenadas por data
        const allTransactions = [...state.transactions].sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateA.getTime() - dateB.getTime();
        });
        
        // Processar todos os meses anteriores ao mês/ano atual
        allTransactions.forEach(t => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return;
          
          const txYear = d.getFullYear();
          const txMonth = d.getMonth();
          
          // Incluir apenas transações de meses anteriores
          // (anos anteriores completos + meses anteriores do ano atual)
          if (txYear < currentYear || (txYear === currentYear && txMonth < monthIndex)) {
            const v = Number(t.value) || 0;
            if (t.category === 'receita') cumulativeBalance += v;
            else if (t.category === 'investimento') cumulativeBalance -= v;
            else if (t.category === 'fixa') cumulativeBalance -= v;
            else if (t.category === 'variavel') cumulativeBalance -= v;
          }
        });
        
        return cumulativeBalance;
      }

      function getMonthTotals(monthIndex) {
        const result = { receitas: 0, investimentos: 0, fixas: 0, variaveis: 0, saldoAnterior: 0 };
        
        // Calcula o saldo acumulado dos meses anteriores
        result.saldoAnterior = getCumulativeBalanceUntilMonth(monthIndex, state.selectedYear);
        
        state.transactions.forEach(t => {
          const d = new Date(t.date);
          if (isNaN(d.getTime()) || d.getMonth() !== monthIndex) return;
          if (state.selectedYear !== 'all' && d.getFullYear() !== state.selectedYear) return;
          const v = Number(t.value) || 0;
          if (t.category === 'receita') result.receitas += v;
          else if (t.category === 'investimento') result.investimentos += v;
          else if (t.category === 'fixa') result.fixas += v;
          else if (t.category === 'variavel') result.variaveis += v;
        });
        
        // Adiciona o saldo anterior às receitas (conforme solicitado)
        result.receitas += result.saldoAnterior;
        
        return result;
      }

      function populateDespesaSubcategorias() {
        const tipo = document.getElementById('despCategoria').value;
        const select = document.getElementById('despSubCategoria');
        select.innerHTML = '';
        let map;
        if (tipo === 'investimento') map = INVEST_SUBCATEGORIES;
        else map = DESPESA_SUBCATEGORIES;
        Object.entries(map).forEach(([value,label]) => {
          const opt = document.createElement('option');
          opt.value = value;
          opt.textContent = label;
          select.appendChild(opt);
        });

        // Se for investimento: esconder campos de cartão e parcelas
        const formaSelect = document.getElementById('despFormaPagamento');
        if (!formaSelect) return;
        if (tipo === 'investimento') {
          formaSelect.value = 'debito_pix'; // default visual
          document.getElementById('despCartaoFields').classList.add('hidden');
          document.getElementById('despParcelasWrapper').classList.add('hidden');
        }
      }

      function updateParcelVisibilityAndCard() {
        const tipo = document.getElementById('despCategoria').value;
        const forma = document.getElementById('despFormaPagamento').value;
        const cartaoWrapper = document.getElementById('despCartaoFields');
        const parcelasWrapper = document.getElementById('despParcelasWrapper');

        // Se for investimento -> esconder ambos sempre
        if (tipo === 'investimento') {
          cartaoWrapper.classList.add('hidden');
          parcelasWrapper.classList.add('hidden');
          return;
        }

        if (forma === 'cartao') {
          cartaoWrapper.classList.remove('hidden');
          parcelasWrapper.classList.remove('hidden');
        } else if (forma === 'boleto') {
          cartaoWrapper.classList.add('hidden');
          parcelasWrapper.classList.remove('hidden');
        } else { // debito_pix / dinheiro
          cartaoWrapper.classList.add('hidden');
          parcelasWrapper.classList.add('hidden');
        }
      }

      function populateEditSubcategories(mainCategory, selectedSub) {
        const select = document.getElementById('editSubCategory');
        select.innerHTML = '';
        let map;
        if (mainCategory === 'receita') map = RECEITA_SUBCATEGORIES;
        else if (mainCategory === 'investimento') map = INVEST_SUBCATEGORIES;
        else map = DESPESA_SUBCATEGORIES;
        Object.entries(map).forEach(([value,label]) => {
          const opt = document.createElement('option');
          opt.value = value;
          opt.textContent = label;
          if (value === selectedSub) opt.selected = true;
          select.appendChild(opt);
        });
      }

      function refreshYearFilterOptions() {
        const select = document.getElementById('yearFilter');
        if (!select) return;
        const currentStored = state.selectedYear === 'all' ? 'all' : String(state.selectedYear);

        // Discover min/max years from transactions
        let minTxYear = null;
        let maxTxYear = null;
        state.transactions.forEach(t => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return;
          const y = d.getFullYear();
          if (minTxYear === null || y < minTxYear) minTxYear = y;
          if (maxTxYear === null || y > maxTxYear) maxTxYear = y;
        });

        const now = new Date();
        const currentYear = now.getFullYear();
        let minYear = minTxYear !== null ? minTxYear : currentYear;
        let maxYear = Math.max(maxTxYear !== null ? maxTxYear : currentYear, currentYear + 1, 2030);
        if (minYear > maxYear) minYear = maxYear;

        const years = [];
        for (let y = minYear; y <= maxYear; y++) years.push(y);

        const orderedYears = [];
        if (years.includes(currentYear)) orderedYears.push(currentYear);
        years.forEach(y => { if (y !== currentYear) orderedYears.push(y); });

        select.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'all';
        optAll.textContent = 'Todos os anos';
        select.appendChild(optAll);

        orderedYears.forEach(y => {
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = y;
          select.appendChild(opt);
        });

        const yearValues = orderedYears.map(y => String(y));
        if (currentStored === 'all') select.value = 'all';
        else if (yearValues.includes(currentStored)) { select.value = currentStored; state.selectedYear = parseInt(currentStored,10); }
        else if (yearValues.includes(String(currentYear))) { select.value = String(currentYear); state.selectedYear = currentYear; }
        else { select.value = 'all'; state.selectedYear = 'all'; }
      }

      function renderHeader() {
        const titleEl = document.getElementById('viewTitle');
        const subtitleEl = document.getElementById('viewSubtitle');

        if (state.selectedMonth === null) {
          if (state.selectedYear === 'all') {
            titleEl.textContent = 'Visão Anual - Resumo Geral';
            subtitleEl.textContent = 'Totais consolidados por mês para todas as transações registradas.';
          } else {
            titleEl.textContent = `Visão Anual - ${state.selectedYear}`;
            subtitleEl.textContent = 'Totais consolidados por mês para o ano selecionado.';
          }
        } else {
          const monthName = MONTH_NAMES[state.selectedMonth];
          if (state.selectedYear === 'all') {
            titleEl.textContent = `Resumo de ${monthName}`;
            subtitleEl.textContent = 'Totais calculados com base nas transações do mês selecionado (todos os anos).';
          } else {
            titleEl.textContent = `Resumo de ${monthName} / ${state.selectedYear}`;
            subtitleEl.textContent = 'Totais calculados com base nas transações do mês e ano selecionados.';
          }
        }

        const yearFilter = document.getElementById('yearFilter');
        if (yearFilter) yearFilter.value = state.selectedYear === 'all' ? 'all' : String(state.selectedYear);
      }

      function renderDelta(elId, atual, anterior) {
        const el = document.getElementById(elId);
        if (!el) return;
        if (anterior === 0) {
          if (atual === 0) {
            el.textContent = 'Sem movimentação no mês anterior.';
          } else {
            el.textContent = 'Sem base para comparação com o mês anterior.';
          }
          el.className = 'text-[11px] mt-0.5 text-gray-400';
          return;
        }

        const diff = atual - anterior;
        const pct = (diff / anterior) * 100;
        const pctStr = Math.abs(pct).toFixed(1).replace('.', ',') + '%';
        if (diff === 0) {
          el.textContent = 'Igual ao mês anterior';
          el.className = 'text-[11px] mt-0.5 text-gray-400';
          return;
        }
        const isUp = diff > 0;
        const arrow = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
        const sign = isUp ? '+' : '-';
        const color = isUp ? 'text-emerald-600' : 'text-red-500';
        el.className = `text-[11px] mt-0.5 ${color} flex items-center gap-1`;
        el.innerHTML = `<i class="fa-solid ${arrow} text-[10px]"></i><span>${sign}${pctStr} em relação ao mês anterior</span>`;
      }

      function updateCardSaldoStyles(value) {
        const card = document.getElementById('cardSaldo');
        if (!card) return;
        card.classList.remove('border-l-emerald-500','border-l-red-500','border-l-slate-500');
        if (value > 0) card.classList.add('border-l-emerald-500');
        else if (value < 0) card.classList.add('border-l-red-500');
        else card.classList.add('border-l-slate-500');
      }

      function renderSummaryCards() {
        const currentMonth = state.selectedMonth;
        const prevMonth = (currentMonth + 11) % 12;

        const currentTotals = getMonthTotals(currentMonth);
        const prevTotals = getMonthTotals(prevMonth);

        const currentSaldo = currentTotals.receitas - currentTotals.investimentos - currentTotals.fixas - currentTotals.variaveis;
        const prevSaldo = prevTotals.receitas - prevTotals.investimentos - prevTotals.fixas - prevTotals.variaveis;

        document.getElementById('totalReceitas').textContent = formatCurrency(currentTotals.receitas);
        document.getElementById('totalInvestimentos').textContent = formatCurrency(currentTotals.investimentos);
        document.getElementById('totalFixas').textContent = formatCurrency(currentTotals.fixas);
        document.getElementById('totalVariaveis').textContent = formatCurrency(currentTotals.variaveis);
        document.getElementById('totalSaldo').textContent = formatCurrency(currentSaldo);

        renderDelta('deltaReceitas', currentTotals.receitas, prevTotals.receitas);
        renderDelta('deltaInvestimentos', currentTotals.investimentos, prevTotals.investimentos);
        renderDelta('deltaFixas', currentTotals.fixas, prevTotals.fixas);
        renderDelta('deltaVariaveis', currentTotals.variaveis, prevTotals.variaveis);
        renderDelta('deltaSaldo', currentSaldo, prevSaldo);

        updateCardSaldoStyles(currentSaldo);
      }

      function renderBudgetRuleCards() {
        const totals = getMonthTotals(state.selectedMonth);
        const renda = totals.receitas;
        const txs = getFilteredTransactions();

        let fixas = 0, variaveis = 0, lazer = 0, investimentos = 0;
        txs.forEach(t => {
          const v = Number(t.value) || 0;
          const sub = (t.subCategory || '').toLowerCase();
          if (t.category === 'fixa') {
            fixas += v;
            if (t.extraLazer || sub === 'lazer') lazer += v;
          }
          else if (t.category === 'variavel') {
            variaveis += v;
            if (sub === 'lazer' || t.extraLazer) lazer += v;
          } else if (t.category === 'investimento') {
            investimentos += v;
          }
        });

        const essenciais = Math.max(0, fixas + variaveis - lazer);
        const limiteEssenciais = renda * 0.50;
        const limiteLazer = renda * 0.30;
        const limiteInvest = renda * 0.20;

        function pct(num) { return (num).toFixed(1).replace('.', ',') + '%'; }
        function fillCard(valueId, metaId, statusId, gasto, limite, colorClass) {
          const valueEl = document.getElementById(valueId);
          const metaEl = document.getElementById(metaId);
          const statusEl = document.getElementById(statusId);
          if (!valueEl || !metaEl || !statusEl) return;

          valueEl.textContent = formatCurrency(gasto);

          if (renda <= 0) {
            metaEl.textContent = 'Sem receitas no período';
            statusEl.textContent = 'Adicione receitas para calcular os percentuais.';
            statusEl.className = 'text-xs font-medium text-gray-500 mt-2';
            return;
          }

          metaEl.textContent = `Limite: ${formatCurrency(limite)}`;
          const usoDaRenda = (gasto / renda) * 100;
          let statusText = `Usando ${pct(usoDaRenda)} da renda.`;
          let statusClass = `text-xs font-medium ${colorClass} mt-2`;
          if (limite > 0 && gasto > limite) {
            const excedentePct = ((gasto - limite) / limite) * 100;
            statusText += ` Excedeu ${pct(excedentePct)} do limite.`;
            statusClass = 'text-xs font-medium text-red-600 mt-2';
          }
          statusEl.textContent = statusText;
          statusEl.className = statusClass;
        }

        fillCard('ruleNeedsValue', 'ruleNeedsMeta', 'ruleNeedsStatus', essenciais, limiteEssenciais, 'text-slate-700');
        fillCard('ruleLeisureValue', 'ruleLeisureMeta', 'ruleLeisureStatus', lazer, limiteLazer, 'text-purple-700');
        fillCard('ruleInvestValue', 'ruleInvestMeta', 'ruleInvestStatus', investimentos, limiteInvest, 'text-emerald-700');
      }

      function updateCardStatusButton(btn, paid) {
        if (!btn) return;
        btn.className = 'card-status-btn mt-1 inline-flex items-center px-2.5 py-1 rounded-full border text-[10px] font-medium';
        const iconClass = paid ? 'fa-thumbs-up' : 'fa-thumbs-down';
        const classes = paid ? ' bg-emerald-50 text-emerald-600 border-emerald-200' : ' bg-red-50 text-red-500 border-red-200';
        btn.className += classes;
        btn.innerHTML = `<i class="fa-solid ${iconClass} mr-1 text-[10px]"></i><span>${paid ? 'Fatura paga' : 'Fatura em aberto'}</span>`;
      }

      function renderCardsFaturas() {
        const txs = getFilteredTransactions().filter((t) => t.isCreditCard);
        const totals = { caixa: 0, inter_debora: 0, inter_cristiano: 0, nubank: 0, c6: 0 };
        const counts = { caixa: 0, inter_debora: 0, inter_cristiano: 0, nubank: 0, c6: 0 };
        let totalFaturas = 0;

        txs.forEach((t) => {
          const v = Number(t.value) || 0;
          totalFaturas += v;
          if (t.card && totals.hasOwnProperty(t.card)) {
            totals[t.card] += v;
            counts[t.card]++;
          }
        });

        document.getElementById('totalFaturas').textContent = formatCurrency(totalFaturas);
        document.getElementById('cardCaixa').textContent = formatCurrency(totals.caixa);
        document.getElementById('cardInterD').textContent = formatCurrency(totals.inter_debora);
        document.getElementById('cardInterC').textContent = formatCurrency(totals.inter_cristiano);
        document.getElementById('cardNubank').textContent = formatCurrency(totals.nubank);
        document.getElementById('cardC6').textContent = formatCurrency(totals.c6);

        // Update item counts
        document.getElementById('cardCount-caixa').textContent = counts.caixa;
        document.getElementById('cardCount-inter_debora').textContent = counts.inter_debora;
        document.getElementById('cardCount-inter_cristiano').textContent = counts.inter_cristiano;
        document.getElementById('cardCount-nubank').textContent = counts.nubank;
        document.getElementById('cardCount-c6').textContent = counts.c6;

        // Add warning for invoices > R$ 2500
        const WARNING_THRESHOLD = 2500;
        ['caixa','inter_debora','inter_cristiano','nubank','c6'].forEach(card => {
          const cardContainer = document.getElementById(`cardContainer-${card}`);
          const cardTotal = totals[card];
          
          // Remove existing warning classes first
          cardContainer.classList.remove('border-l-red-500', 'border-l-yellow-500');
          
          // Add warning if threshold exceeded
          if (cardTotal > WARNING_THRESHOLD) {
            cardContainer.classList.add('border-l-red-500');
            cardContainer.classList.remove('border-l-sky-500', 'border-l-orange-500', 'border-l-orange-400', 'border-l-violet-600', 'border-l-slate-700');
          }
        });

        const year = getYearForSelectedMonth();
        const m = state.selectedMonth;
        ['caixa','inter_debora','inter_cristiano','nubank','c6'].forEach(card => {
          const key = keyInvoice(year, m, card);
          const paid = !!state.invoicesPaid[key];
          const btn = document.querySelector(`.card-status-btn[data-card="${card}"]`);
          updateCardStatusButton(btn, paid);
        });
      }

      // Build generic rows (receitas / fixas / variaveis)
      function buildTableRows(list, tbodyId, emptyText) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';

        // Se for a tabela de receitas e houver um mês selecionado, adicionar linha com saldo anterior
        if (tbodyId === 'tbodyReceitas' && state.selectedMonth !== null) {
          const saldoAnterior = getCumulativeBalanceUntilMonth(state.selectedMonth, state.selectedYear);
          
          if (saldoAnterior !== 0) {  // Só mostra se houver saldo anterior
            const tr = document.createElement('tr');
            tr.className = 'bg-blue-50/30 border-l-4 border-l-blue-400';
            tr.innerHTML = `
              <td class="px-4 py-2 text-xs text-blue-700 whitespace-nowrap font-semibold" colspan="2">
                <i class="fa-solid fa-arrow-right-arrow-left mr-1"></i>Saldo do mês anterior
              </td>
              <td class="px-4 py-2 text-xs text-blue-600">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium bg-blue-50 text-blue-700 border-blue-200">Saldo Acumulado</span>
              </td>
              <td class="px-4 py-2 text-xs text-blue-600">-</td>
              <td class="px-4 py-2 text-xs text-blue-800 text-right font-semibold">${formatCurrency(saldoAnterior)}</td>
              <td class="px-4 py-2 text-xs text-center">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full border bg-blue-50 text-blue-600 border-blue-200">
                  <i class="fa-solid fa-info-circle mr-1 text-[10px]"></i>
                  <span class="text-[10px] font-medium">Automático</span>
                </span>
              </td>
              <td class="px-4 py-2 text-xs text-center text-blue-400">-</td>
            `;
            tbody.appendChild(tr);
          }
        }

        if (!list.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="7" class="px-4 py-4 text-center text-xs text-gray-400">${emptyText}</td>`;
          tbody.appendChild(tr);
          return;
        }

        list.forEach((t, index) => {
          const tr = document.createElement('tr');
          const zebra = index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50';
          tr.className = zebra;

          const categoriaBaseLabel = CATEGORY_LABELS[t.category] || '-';
          const sub = (t.subCategory || '').toLowerCase();
          let badgesHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium text-gray-600 bg-gray-50 border-gray-200 mr-1">${categoriaBaseLabel}</span>`;

          if (t.subCategory) {
            let map;
            if (t.category === 'receita') map = RECEITA_SUBCATEGORIES;
            else if (t.category === 'investimento') map = INVEST_SUBCATEGORIES;
            else map = DESPESA_SUBCATEGORIES;
            const subLabel = map[t.subCategory] || map[sub];
            if (subLabel) {
              const colorClasses = SUBCATEGORY_COLOR_CLASSES[t.subCategory] || SUBCATEGORY_COLOR_CLASSES[sub] || 'bg-gray-50 text-gray-700 border-gray-200';
              badgesHTML += `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${colorClasses}">${subLabel}</span>`;
            }
          }
          if (t.extraLazer && sub !== 'lazer') {
            const colorClasses = SUBCATEGORY_COLOR_CLASSES['lazer'] || 'bg-purple-50 text-purple-700 border-purple-200';
            badgesHTML += `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${colorClasses}">Lazer</span>`;
          }

          let pagamentoTexto = '-';
          if (t.isCreditCard && t.card) pagamentoTexto = CARD_LABELS[t.card] || '-';
          else if (t.paymentMethod === 'debito_pix') pagamentoTexto = 'Débito/Pix';
          else if (t.paymentMethod === 'boleto') pagamentoTexto = 'Boleto';

          let statusHtml = '';
          if (t.isCreditCard) {
            statusHtml = `<span class="text-[11px] text-gray-400">Cartão</span>`;
          } else {
            const isReceita = t.category === 'receita';
            const statusLabel = isReceita ? (t.paid ? 'Recebido' : 'Não recebido') : (t.paid ? 'Pago' : 'Não pago');
            const statusIcon  = t.paid ? 'fa-thumbs-up' : 'fa-thumbs-down';
            const statusClasses = t.paid ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-red-50 text-red-500 border-red-200';
            statusHtml = `<button class="btn-toggle-paid inline-flex items-center justify-center px-2.5 py-1 rounded-full border ${statusClasses}" data-id="${t.id}" title="${statusLabel}"><i class="fa-solid ${statusIcon} mr-1 text-[10px]"></i><span class="text-[10px] font-medium">${statusLabel}</span></button>`;
          }

          tr.innerHTML = `
            <td class="px-4 py-2 text-xs text-gray-700 whitespace-nowrap">${formatDate(t.date)}</td>
            <td class="px-4 py-2 text-xs text-gray-800">${t.description || '-'}</td>
            <td class="px-4 py-2 text-xs text-gray-600"><div class="flex flex-wrap gap-1">${badgesHTML}</div></td>
            <td class="px-4 py-2 text-xs text-gray-600">${pagamentoTexto}</td>
            <td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(t.value)}</td>
            <td class="px-4 py-2 text-xs text-center">${statusHtml}</td>
            <td class="px-4 py-2 text-xs text-center">
              <div class="flex items-center justify-center gap-1">
                <button class="btn-edit inline-flex items-center justify-center w-7 h-7 rounded-full border border-indigo-100 text-indigo-500 hover:bg-indigo-50" data-id="${t.id}" title="Editar"><i class="fa-solid fa-pen text-[10px]"></i></button>
                <button class="btn-delete inline-flex items-center justify-center w-7 h-7 rounded-full border border-red-100 text-red-500 hover:bg-red-50" data-id="${t.id}" title="Excluir"><i class="fa-solid fa-trash text-[11px]"></i></button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Build rows specifically for investimentos (com toggle aportado)
      function buildInvestRows(list, tbodyId, emptyText) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';

        if (!list.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" class="px-4 py-4 text-center text-xs text-gray-400">${emptyText}</td>`;
          tbody.appendChild(tr);
          return;
        }

        list.forEach((t, index) => {
          const tr = document.createElement('tr');
          const zebra = index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50';
          tr.className = zebra;

          const subLabel = t.subCategory ? (INVEST_SUBCATEGORIES[t.subCategory] || t.subCategory) : '-';

          const aportado = !!t.aportado;
          const btnClass = aportado ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-600 border-gray-200';
          const icon = aportado ? 'fa-check' : 'fa-hourglass-half';
          const statusHtml = `<button class="btn-toggle-aportado inline-flex items-center justify-center px-2.5 py-1 rounded-full border ${btnClass}" data-id="${t.id}" title="${aportado ? 'Aportado' : 'Não aportado'}"><i class="fa-solid ${icon} mr-1 text-[10px]"></i><span class="text-[10px] font-medium">${aportado ? 'Aportado' : 'Não aportado'}</span></button>`;

          tr.innerHTML = `
            <td class="px-4 py-2 text-xs text-gray-700 whitespace-nowrap">${formatDate(t.date)}</td>
            <td class="px-4 py-2 text-xs text-gray-800">${t.description || '-'}</td>
            <td class="px-4 py-2 text-xs text-gray-700">${subLabel}</td>
            <td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(t.value)}</td>
            <td class="px-4 py-2 text-xs text-center">${statusHtml}</td>
            <td class="px-4 py-2 text-xs text-center">
              <div class="flex items-center justify-center gap-1">
                <button class="btn-edit inline-flex items-center justify-center w-7 h-7 rounded-full border border-indigo-100 text-indigo-500 hover:bg-indigo-50" data-id="${t.id}" title="Editar"><i class="fa-solid fa-pen text-[10px]"></i></button>
                <button class="btn-delete inline-flex items-center justify-center w-7 h-7 rounded-full border border-red-100 text-red-500 hover:bg-red-50" data-id="${t.id}" title="Excluir"><i class="fa-solid fa-trash text-[11px]"></i></button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Build card view for mobile
      function buildCardView(list, cardViewId, emptyText) {
        const cardView = document.getElementById(cardViewId);
        cardView.innerHTML = '';

        if (!list.length) {
          cardView.innerHTML = `<div class="px-4 py-8 text-center text-sm text-gray-400">${emptyText}</div>`;
          return;
        }

        list.forEach((t) => {
          const card = document.createElement('div');
          card.className = 'transaction-card';

          const categoriaBaseLabel = CATEGORY_LABELS[t.category] || '-';
          const sub = (t.subCategory || '').toLowerCase();
          let badgesHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium text-gray-600 bg-gray-50 border-gray-200 mr-1">${categoriaBaseLabel}</span>`;

          if (t.subCategory) {
            let map;
            if (t.category === 'receita') map = RECEITA_SUBCATEGORIES;
            else if (t.category === 'investimento') map = INVEST_SUBCATEGORIES;
            else map = DESPESA_SUBCATEGORIES;
            const subLabel = map[t.subCategory] || map[sub];
            if (subLabel) {
              const colorClasses = SUBCATEGORY_COLOR_CLASSES[t.subCategory] || SUBCATEGORY_COLOR_CLASSES[sub] || 'bg-gray-50 text-gray-700 border-gray-200';
              badgesHTML += `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${colorClasses}">${subLabel}</span>`;
            }
          }
          if (t.extraLazer && sub !== 'lazer') {
            const colorClasses = SUBCATEGORY_COLOR_CLASSES['lazer'] || 'bg-purple-50 text-purple-700 border-purple-200';
            badgesHTML += `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${colorClasses}">Lazer</span>`;
          }

          let pagamentoTexto = '-';
          if (t.isCreditCard && t.card) pagamentoTexto = CARD_LABELS[t.card] || '-';
          else if (t.paymentMethod === 'debito_pix') pagamentoTexto = 'Débito/Pix';
          else if (t.paymentMethod === 'boleto') pagamentoTexto = 'Boleto';

          let statusHtml = '';
          if (t.isCreditCard) {
            statusHtml = `<span class="text-xs text-gray-400">Cartão</span>`;
          } else {
            const isReceita = t.category === 'receita';
            const statusLabel = isReceita ? (t.paid ? 'Recebido' : 'Não recebido') : (t.paid ? 'Pago' : 'Não pago');
            const statusIcon  = t.paid ? 'fa-thumbs-up' : 'fa-thumbs-down';
            const statusClasses = t.paid ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-red-50 text-red-500 border-red-200';
            statusHtml = `<button class="btn-toggle-paid inline-flex items-center justify-center px-3 py-1.5 rounded-full border ${statusClasses}" data-id="${t.id}" title="${statusLabel}"><i class="fa-solid ${statusIcon} mr-1 text-xs"></i><span class="text-xs font-medium">${statusLabel}</span></button>`;
          }

          card.innerHTML = `
            <div class="card-header">
              <div class="card-title">${t.description || '-'}</div>
              <div class="card-value">${formatCurrency(t.value)}</div>
            </div>
            <div class="card-body">
              <div class="card-field">
                <span class="card-label">Data:</span>
                <span class="card-value-text">${formatDate(t.date)}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Categoria:</span>
                <span class="card-value-text"><div class="flex flex-wrap gap-1 justify-end">${badgesHTML}</div></span>
              </div>
              <div class="card-field">
                <span class="card-label">Pagamento:</span>
                <span class="card-value-text">${pagamentoTexto}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Status:</span>
                <span class="card-value-text">${statusHtml}</span>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn-edit px-4 py-2 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1" data-id="${t.id}">
                <i class="fa-solid fa-pen text-[10px]"></i> Editar
              </button>
              <button class="btn-delete px-4 py-2 text-xs font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center gap-1" data-id="${t.id}">
                <i class="fa-solid fa-trash text-[10px]"></i> Excluir
              </button>
            </div>
          `;
          cardView.appendChild(card);
        });
      }

      // Build card view for investimentos
      function buildInvestCardView(list, cardViewId, emptyText) {
        const cardView = document.getElementById(cardViewId);
        cardView.innerHTML = '';

        if (!list.length) {
          cardView.innerHTML = `<div class="px-4 py-8 text-center text-sm text-gray-400">${emptyText}</div>`;
          return;
        }

        list.forEach((t) => {
          const card = document.createElement('div');
          card.className = 'transaction-card';

          const categoriaBaseLabel = CATEGORY_LABELS[t.category] || '-';
          let badgesHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium text-gray-600 bg-gray-50 border-gray-200 mr-1">${categoriaBaseLabel}</span>`;

          if (t.subCategory) {
            const subLabel = INVEST_SUBCATEGORIES[t.subCategory];
            if (subLabel) {
              const colorClasses = SUBCATEGORY_COLOR_CLASSES[t.subCategory] || 'bg-gray-50 text-gray-700 border-gray-200';
              badgesHTML += `<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${colorClasses}">${subLabel}</span>`;
            }
          }

          const aportLabel = t.aportado ? 'Aportado' : 'Não aportado';
          const aportIcon  = t.aportado ? 'fa-thumbs-up' : 'fa-thumbs-down';
          const aportClasses = t.aportado ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-gray-50 text-gray-500 border-gray-200';

          card.innerHTML = `
            <div class="card-header">
              <div class="card-title">${t.description || '-'}</div>
              <div class="card-value">${formatCurrency(t.value)}</div>
            </div>
            <div class="card-body">
              <div class="card-field">
                <span class="card-label">Data:</span>
                <span class="card-value-text">${formatDate(t.date)}</span>
              </div>
              <div class="card-field">
                <span class="card-label">Tipo:</span>
                <span class="card-value-text"><div class="flex flex-wrap gap-1 justify-end">${badgesHTML}</div></span>
              </div>
              <div class="card-field">
                <span class="card-label">Aportado:</span>
                <span class="card-value-text">
                  <button class="btn-toggle-aportado inline-flex items-center justify-center px-3 py-1.5 rounded-full border ${aportClasses}" data-id="${t.id}">
                    <i class="fa-solid ${aportIcon} mr-1 text-xs"></i><span class="text-xs font-medium">${aportLabel}</span>
                  </button>
                </span>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn-edit px-4 py-2 text-xs font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1" data-id="${t.id}">
                <i class="fa-solid fa-pen text-[10px]"></i> Editar
              </button>
              <button class="btn-delete px-4 py-2 text-xs font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center gap-1" data-id="${t.id}">
                <i class="fa-solid fa-trash text-[10px]"></i> Excluir
              </button>
            </div>
          `;
          cardView.appendChild(card);
        });
      }

      function renderTables() {
        const all = getFilteredTransactions().sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        const receitas  = all.filter(t => t.category === 'receita');
        const fixas     = all.filter(t => t.category === 'fixa');
        const variaveis = all.filter(t => t.category === 'variavel');
        const investimentos = all.filter(t => t.category === 'investimento');

        // Build table views
        buildTableRows(receitas, 'tbodyReceitas', 'Nenhuma receita cadastrada para este período.');
        buildTableRows(fixas, 'tbodyFixas', 'Nenhuma despesa fixa cadastrada para este período.');
        buildTableRows(variaveis, 'tbodyVariaveis', 'Nenhuma despesa variável neste período.');
        buildInvestRows(investimentos, 'tbodyInvestimentos', 'Nenhum investimento registrado neste período.');

        // Build card views for mobile
        buildCardView(receitas, 'cardViewReceitas', 'Nenhuma receita cadastrada para este período.');
        buildCardView(fixas, 'cardViewFixas', 'Nenhuma despesa fixa cadastrada para este período.');
        buildCardView(variaveis, 'cardViewVariaveis', 'Nenhuma despesa variável neste período.');
        buildInvestCardView(investimentos, 'cardViewInvestimentos', 'Nenhum investimento registrado neste período.');

        // bind buttons
        document.querySelectorAll('.btn-delete').forEach((btn) => {
          btn.addEventListener('click', () => openDeleteModal(btn.getAttribute('data-id')));
        });
        document.querySelectorAll('.btn-edit').forEach((btn) => {
          btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-id')));
        });
        document.querySelectorAll('.btn-toggle-paid').forEach((btn) => {
          btn.addEventListener('click', () => togglePaid(btn.getAttribute('data-id')));
        });
        document.querySelectorAll('.btn-toggle-aportado').forEach((btn) => {
          btn.addEventListener('click', () => toggleAportado(btn.getAttribute('data-id')));
        });
        
        // Re-initialize table filters after rendering
        setupTableFilters();
        
        // Update payment progress bar
        updatePaymentProgress();
      }
      
      // ---------- PAYMENT PROGRESS BAR ----------
      function updatePaymentProgress() {
        const filtered = getFilteredTransactions();
        
        // Only count items that can be marked as paid (exclude receitas)
        const payableItems = filtered.filter(t => t.category !== 'receita');
        const totalItems = payableItems.length;
        
        // Count paid items - include individual paid status AND credit card invoices marked as paid
        const paidItems = payableItems.filter(t => {
          // If individually marked as paid or aportado
          if (t.paid || t.aportado) return true;
          
          // If it's a credit card transaction, check if the invoice is paid
          if (t.isCreditCard || t.paymentMethod === 'cartao') {
            const d = new Date(t.date);
            if (!isNaN(d.getTime())) {
              const year = d.getFullYear();
              const month = d.getMonth();
              const card = t.card || 'Sem cartão';
              const key = keyInvoice(year, month, card);
              if (state.invoicesPaid[key]) return true;
            }
          }
          
          return false;
        }).length;
        
        const percentage = totalItems > 0 ? Math.round((paidItems / totalItems) * 100) : 0;
        
        // Update progress bar
        const progressBar = document.getElementById('paymentProgressBar');
        const percentageDisplay = document.getElementById('paymentPercentage');
        const countDisplay = document.getElementById('paymentCount');
        const statusMessage = document.getElementById('paymentStatusMessage');
        
        if (!progressBar || !percentageDisplay || !countDisplay || !statusMessage) return;
        
        progressBar.style.width = percentage + '%';
        percentageDisplay.textContent = percentage + '%';
        countDisplay.textContent = `${paidItems} de ${totalItems} pagos`;
        
        // Update status message and bar color - always green
        if (percentage === 0) {
          statusMessage.innerHTML = '<p class="text-xs text-emerald-600 text-center">Marque seus lançamentos como pagos para ver o progresso</p>';
          progressBar.className = 'h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-300 ease-out';
        } else if (percentage < 50) {
          statusMessage.innerHTML = '<p class="text-xs text-emerald-600 text-center"><i class="fa-solid fa-hourglass-half mr-1"></i>Continue marcando seus pagamentos</p>';
          progressBar.className = 'h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-300 ease-out';
        } else if (percentage < 100) {
          statusMessage.innerHTML = '<p class="text-xs text-emerald-600 text-center"><i class="fa-solid fa-chart-line mr-1"></i>Você está quase lá!</p>';
          progressBar.className = 'h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-300 ease-out';
        } else {
          statusMessage.innerHTML = '<p class="text-xs text-emerald-600 font-semibold text-center"><i class="fa-solid fa-circle-check mr-1"></i>Parabéns! Todos os itens estão pagos! 🎉</p>';
          progressBar.className = 'h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-300 ease-out';
        }
      }

      // ---------- ANNUAL COMPUTATION & CHART RENDERS ----------
      function computeAnnualData() {
        const monthly = [];
        for (let m = 0; m < 12; m++) monthly[m] = { monthIndex: m, receitas: 0, receitasProprias: 0, saldoAnterior: 0, despesas: 0, despesasFixas: 0, despesasVariaveis: 0, investimentos: 0, saldo: 0, investMes: 0 };

        const txSource = state.transactions.filter((t) => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return false;
          if (state.selectedYear === 'all') return true;
          return d.getFullYear() === state.selectedYear;
        });

        const investByType = {};
        let totalReceitasYear = 0, totalDespesasYear = 0, totalDespesasFixas = 0, totalDespesasVariaveis = 0;
        let totalInvestYear = 0, totalSaldoYear = 0, maxInvestSingle = 0;
        let totalDespesaCount = 0; // For average ticket calculation

        txSource.forEach((t) => {
          const d = new Date(t.date);
          if (isNaN(d.getTime())) return;
          const m = d.getMonth();
          const v = Number(t.value) || 0;

          if (t.category === 'receita') { 
            monthly[m].receitasProprias += v;  // Receitas próprias (sem saldo anterior)
            totalReceitasYear += v; 
          }
          else if (t.category === 'investimento') {
            monthly[m].investimentos += v; 
            monthly[m].investMes += v; 
            totalInvestYear += v;
            if (v > maxInvestSingle) maxInvestSingle = v;
            if (t.subCategory) investByType[t.subCategory] = (investByType[t.subCategory] || 0) + v;
          } else if (t.category === 'fixa') {
            monthly[m].despesas += v; 
            monthly[m].despesasFixas += v;
            totalDespesasYear += v;
            totalDespesasFixas += v;
            totalDespesaCount++;
          } else if (t.category === 'variavel') {
            monthly[m].despesas += v; 
            monthly[m].despesasVariaveis += v;
            totalDespesasYear += v;
            totalDespesasVariaveis += v;
            totalDespesaCount++;
          }
        });

        // Calcular saldo acumulado e adicionar às receitas
        let saldoAcumulado = 0;
        monthly.forEach((mData) => { 
          mData.saldoAnterior = saldoAcumulado;
          mData.receitas = mData.receitasProprias + saldoAcumulado;  // Receitas totais = próprias + saldo anterior
          mData.saldo = mData.receitas - mData.despesas - mData.investimentos; 
          saldoAcumulado += (mData.receitasProprias - mData.despesas - mData.investimentos);  // Atualiza acumulado com receitas próprias
          totalSaldoYear += mData.saldo; 
        });

        // Calculate new KPIs
        const savingsRate = totalReceitasYear > 0 ? (totalInvestYear / totalReceitasYear * 100) : 0;
        const fixedPercentage = totalDespesasYear > 0 ? (totalDespesasFixas / totalDespesasYear * 100) : 0;
        const variablePercentage = totalDespesasYear > 0 ? (totalDespesasVariaveis / totalDespesasYear * 100) : 0;
        const avgTicket = totalDespesaCount > 0 ? (totalDespesasYear / totalDespesaCount) : 0;
        
        // Calculate month-over-month growth (based on saldo)
        let momGrowthSum = 0;
        let momGrowthCount = 0;
        for (let i = 1; i < 12; i++) {
          if (monthly[i-1].saldo !== 0) {
            const growth = ((monthly[i].saldo - monthly[i-1].saldo) / Math.abs(monthly[i-1].saldo)) * 100;
            momGrowthSum += growth;
            momGrowthCount++;
          }
        }
        const avgMoMGrowth = momGrowthCount > 0 ? (momGrowthSum / momGrowthCount) : 0;

        return {
          monthly,
          totals: { 
            totalReceitasYear, 
            totalDespesasYear, 
            totalDespesasFixas,
            totalDespesasVariaveis,
            totalInvestYear, 
            totalSaldoYear, 
            maxInvestSingle,
            savingsRate,
            fixedPercentage,
            variablePercentage,
            avgTicket,
            avgMoMGrowth
          },
          investByType,
          txSource
        };
      }

      function renderAnnualCharts(monthly, totals) {
        const labels = monthly.map(m => MONTH_NAMES[m.monthIndex].slice(0, 3));
        const receitas = monthly.map(m => m.receitas);
        const despesas = monthly.map(m => m.despesas);
        const investimentos = monthly.map(m => m.investimentos);
        const saldos = monthly.map(m => m.saldo);

        // Calculate accumulated values
        let accReceitas = 0, accDespesas = 0, accInvestimentos = 0;
        const accumulatedReceitas = monthly.map(m => { accReceitas += m.receitas; return accReceitas; });
        const accumulatedDespesas = monthly.map(m => { accDespesas += m.despesas; return accDespesas; });
        const accumulatedInvestimentos = monthly.map(m => { accInvestimentos += m.investimentos; return accInvestimentos; });

        // Bar Chart - Monthly comparison
        const barCanvas = document.getElementById('chartAnnualBars');
        if (barCanvas && typeof Chart !== 'undefined') {
          const barCtx = barCanvas.getContext('2d');
          if (annualBarChart) annualBarChart.destroy();
          
          annualBarChart = new Chart(barCtx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Receitas', data: receitas, backgroundColor: 'rgba(16,185,129,0.7)', borderColor: 'rgba(5,150,105,1)', borderWidth: 2 },
                { label: 'Despesas', data: despesas, backgroundColor: 'rgba(249,115,22,0.7)', borderColor: 'rgba(234,88,12,1)', borderWidth: 2 },
                { label: 'Investimentos', data: investimentos, backgroundColor: 'rgba(59,130,246,0.7)', borderColor: 'rgba(37,99,235,1)', borderWidth: 2 }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { 
                legend: { position: 'top', labels: { font: { size: 11, weight: 'bold' } } }, 
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } 
              },
              scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v), font: { size: 10 } } } }
            }
          });
        }

        // Line Chart - Balance evolution
        const saldoCanvas = document.getElementById('chartAnnualSaldo');
        if (saldoCanvas && typeof Chart !== 'undefined') {
          const saldoCtx = saldoCanvas.getContext('2d');
          if (annualLineChart) annualLineChart.destroy();
          
          annualLineChart = new Chart(saldoCtx, {
            type: 'line',
            data: { 
              labels, 
              datasets: [{ 
                label: 'Saldo Mensal', 
                data: saldos, 
                tension: 0.4, 
                fill: true, 
                backgroundColor: 'rgba(15,23,42,0.1)', 
                borderColor: 'rgba(15,23,42,1)', 
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: 'rgba(15,23,42,1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }] 
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { 
                legend: { display: false }, 
                tooltip: { callbacks: { label: ctx => `Saldo: ${formatCurrency(ctx.parsed.y)}` } } 
              },
              scales: { y: { ticks: { callback: v => formatCurrency(v), font: { size: 10 } } } }
            }
          });
        }

        // Area Chart - Accumulated values
        const accCanvas = document.getElementById('chartAnnualAccumulated');
        if (accCanvas && typeof Chart !== 'undefined') {
          const accCtx = accCanvas.getContext('2d');
          if (annualAccumulatedChart) annualAccumulatedChart.destroy();
          
          annualAccumulatedChart = new Chart(accCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                { 
                  label: 'Receitas Acumuladas', 
                  data: accumulatedReceitas, 
                  tension: 0.4, 
                  fill: true, 
                  backgroundColor: 'rgba(16,185,129,0.2)', 
                  borderColor: 'rgba(5,150,105,1)', 
                  borderWidth: 3,
                  pointRadius: 3
                },
                { 
                  label: 'Despesas Acumuladas', 
                  data: accumulatedDespesas, 
                  tension: 0.4, 
                  fill: true, 
                  backgroundColor: 'rgba(249,115,22,0.2)', 
                  borderColor: 'rgba(234,88,12,1)', 
                  borderWidth: 3,
                  pointRadius: 3
                },
                { 
                  label: 'Investimentos Acumulados', 
                  data: accumulatedInvestimentos, 
                  tension: 0.4, 
                  fill: true, 
                  backgroundColor: 'rgba(59,130,246,0.2)', 
                  borderColor: 'rgba(37,99,235,1)', 
                  borderWidth: 3,
                  pointRadius: 3
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { 
                legend: { position: 'top', labels: { font: { size: 11, weight: 'bold' } } }, 
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } 
              },
              scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v), font: { size: 10 } } } }
            }
          });
        }

        // Pie Chart - Expense distribution (Fixed vs Variable)
        const expCanvas = document.getElementById('chartExpenseDistribution');
        if (expCanvas && typeof Chart !== 'undefined' && totals) {
          const expCtx = expCanvas.getContext('2d');
          if (expenseDistributionChart) expenseDistributionChart.destroy();
          
          if (totals.totalDespesasYear > 0) {
            expenseDistributionChart = new Chart(expCtx, {
              type: 'doughnut',
              data: {
                labels: ['Despesas Fixas', 'Despesas Variáveis'],
                datasets: [{
                  data: [totals.totalDespesasFixas, totals.totalDespesasVariaveis],
                  backgroundColor: ['rgba(249,115,22,0.8)', 'rgba(251,146,60,0.8)'],
                  borderWidth: 3,
                  borderColor: '#ffffff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'bottom', labels: { font: { size: 11, weight: 'bold' } } },
                  tooltip: {
                    callbacks: {
                      label: ctx => {
                        const value = ctx.parsed || 0;
                        const pct = totals.totalDespesasYear > 0 ? (value / totals.totalDespesasYear * 100).toFixed(1).replace('.', ',') : '0,0';
                        return `${ctx.label}: ${formatCurrency(value)} (${pct}%)`;
                      }
                    }
                  }
                }
              }
            });
          }
        }
      }

      function renderInvestTypeChart(investByType, totalInvestYear) {
        const canvas = document.getElementById('chartInvestTypes');
        if (!canvas || typeof Chart === 'undefined') return;
        const ctx = canvas.getContext('2d');
        if (investPieChart) { investPieChart.destroy(); investPieChart = null; }

        const entries = Object.entries(investByType);
        if (!entries.length || totalInvestYear <= 0) {
          // clear canvas by creating empty chart or just return
          return;
        }

        const labels = entries.map(([sub]) => INVEST_SUBCATEGORIES[sub] || 'Outro');
        const data = entries.map(([, v]) => v);

        investPieChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels, datasets: [{ data, backgroundColor: ['rgba(59,130,246,0.7)','rgba(16,185,129,0.7)','rgba(249,115,22,0.7)','rgba(139,92,246,0.7)','rgba(20,184,166,0.7)','rgba(245,158,11,0.7)','rgba(148,163,184,0.7)'], borderWidth:1, borderColor:'#ffffff' }] },
          options: {
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: ctx => {
              const value = ctx.parsed || 0;
              const pct = totalInvestYear>0 ? (value/totalInvestYear*100).toFixed(1).replace('.',',') : '0,0';
              return `${ctx.label}: ${formatCurrency(value)} (${pct}%)`;
            }}}}
          }
        });
      }

      function renderAnnualInvestSummary(investByType, totalInvestYear) {
        const tbody = document.getElementById('annualInvestBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const entries = Object.entries(investByType);
        if (!entries.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-xs text-gray-400 text-center">Nenhum investimento registrado no período selecionado.</td></tr>`;
          return;
        }
        entries.sort((a,b)=>b[1]-a[1]);
        entries.forEach(([sub,value]) => {
          const label = INVEST_SUBCATEGORIES[sub] || 'Outro';
          const pct = totalInvestYear>0 ? (value/totalInvestYear*100).toFixed(1).replace('.',',') : '0,0';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-4 py-2 text-xs text-gray-700">${label}</td><td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(value)}</td><td class="px-4 py-2 text-xs text-gray-800 text-right">${pct}%</td>`;
          tbody.appendChild(tr);
        });
        const trTotal = document.createElement('tr');
        trTotal.className = 'bg-gray-50/80';
        trTotal.innerHTML = `<td class="px-4 py-2 text-xs font-semibold text-gray-900">Total</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">${formatCurrency(totalInvestYear)}</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">100%</td>`;
        tbody.appendChild(trTotal);
      }

      function renderAnnualView() {
        const { monthly, totals, investByType } = computeAnnualData();
        const { 
          totalReceitasYear, totalDespesasYear, totalInvestYear, totalSaldoYear, maxInvestSingle,
          savingsRate, fixedPercentage, variablePercentage, avgTicket, avgMoMGrowth
        } = totals;

        const tbody = document.getElementById('annualBody');
        tbody.innerHTML = '';

        monthly.forEach((mData, index) => {
          const tr = document.createElement('tr');
          tr.className = index%2===0 ? 'bg-white' : 'bg-gray-50/50';
          const saldoNegativo = mData.saldo < 0;
          const saldoClass = saldoNegativo ? 'text-red-700 font-bold' : 'text-gray-800';
          const saldoIcon = saldoNegativo ? '<i class="fa-solid fa-exclamation-triangle text-red-600 mr-1"></i>' : '';
          tr.innerHTML = `<td class="px-4 py-2 text-xs text-gray-700">${MONTH_NAMES[mData.monthIndex]}</td><td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(mData.receitas)}</td><td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(mData.despesas)}</td><td class="px-4 py-2 text-xs text-gray-800 text-right">${formatCurrency(mData.investimentos)}</td><td class="px-4 py-2 text-xs ${saldoClass} text-right">${saldoIcon}${formatCurrency(mData.saldo)}</td>`;
          tbody.appendChild(tr);
        });

        const trTotal = document.createElement('tr');
        trTotal.className = 'bg-gray-100/80';
        trTotal.innerHTML = `<td class="px-4 py-2 text-xs font-semibold text-gray-900">Total</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">${formatCurrency(totalReceitasYear)}</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">${formatCurrency(totalDespesasYear)}</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">${formatCurrency(totalInvestYear)}</td><td class="px-4 py-2 text-xs font-semibold text-gray-900 text-right">${formatCurrency(totalSaldoYear)}</td>`;
        tbody.appendChild(trTotal);

        // Update main KPI cards with trend indicators
        const avgMonthlyReceitas = totalReceitasYear / 12;
        const avgMonthlyDespesas = totalDespesasYear / 12;
        const avgMonthlyInvest = totalInvestYear / 12;
        const avgMonthlySaldo = totalSaldoYear / 12;

        document.getElementById('annualTotalReceitas').textContent = formatCurrency(totalReceitasYear);
        document.getElementById('annualTotalDespesas').textContent = formatCurrency(totalDespesasYear);
        document.getElementById('annualTotalInvest').textContent = formatCurrency(totalInvestYear);
        
        // Add red styling for negative annual balance
        const annualSaldoElement = document.getElementById('annualTotalSaldo');
        const annualSaldoCard = annualSaldoElement.closest('.bg-gradient-to-br');
        annualSaldoElement.textContent = formatCurrency(totalSaldoYear);
        if (totalSaldoYear < 0) {
          annualSaldoElement.classList.add('text-red-700');
          annualSaldoElement.classList.remove('text-slate-900');
          // Add red border and background to card
          annualSaldoCard.classList.remove('from-slate-50', 'to-slate-100/50', 'border-slate-200');
          annualSaldoCard.classList.add('from-red-50', 'to-red-100/50', 'border-red-500');
        } else {
          annualSaldoElement.classList.remove('text-red-700');
          annualSaldoElement.classList.add('text-slate-900');
          // Restore original colors
          annualSaldoCard.classList.remove('from-red-50', 'to-red-100/50', 'border-red-500');
          annualSaldoCard.classList.add('from-slate-50', 'to-slate-100/50', 'border-slate-200');
        }

        // Trend indicators (comparing with average)
        document.getElementById('annualReceitasTrend').innerHTML = `<i class="fa-solid fa-equals text-xs"></i> ${formatCurrency(avgMonthlyReceitas)}`;
        document.getElementById('annualDespesasTrend').innerHTML = `<i class="fa-solid fa-equals text-xs"></i> ${formatCurrency(avgMonthlyDespesas)}`;
        document.getElementById('annualInvestTrend').innerHTML = `<i class="fa-solid fa-equals text-xs"></i> ${formatCurrency(avgMonthlyInvest)}`;
        document.getElementById('annualSaldoTrend').textContent = formatCurrency(avgMonthlySaldo);

        // Update new KPI cards
        document.getElementById('annualSavingsRate').textContent = savingsRate.toFixed(1).replace('.', ',') + '%';
        document.getElementById('annualFixedVsVariable').textContent = `${fixedPercentage.toFixed(0)}% / ${variablePercentage.toFixed(0)}%`;
        
        const momIcon = avgMoMGrowth >= 0 ? '↑' : '↓';
        const momColor = avgMoMGrowth >= 0 ? 'text-teal-600' : 'text-rose-600';
        document.getElementById('annualMoMGrowth').innerHTML = `<span class="${momColor}">${momIcon} ${Math.abs(avgMoMGrowth).toFixed(1).replace('.', ',')}%</span>`;
        
        document.getElementById('annualAvgTicket').textContent = formatCurrency(avgTicket);

        // Investment summary card
        document.getElementById('annualCardInvestTotal').textContent = formatCurrency(totalInvestYear);
        document.getElementById('annualCardInvestMax').textContent = formatCurrency(maxInvestSingle);

        let bestMonthIndex = null; let bestMonthValue = 0;
        monthly.forEach((mData) => { if (mData.investMes > bestMonthValue) { bestMonthValue = mData.investMes; bestMonthIndex = mData.monthIndex; } });
        const bestMonthLabel = bestMonthIndex !== null ? MONTH_NAMES[bestMonthIndex] : '-';
        document.getElementById('annualCardInvestBestMonth').textContent = bestMonthValue > 0 ? `${bestMonthLabel} (${formatCurrency(bestMonthValue)})` : '-';

        // Render all charts with new totals parameter
        renderAnnualCharts(monthly, totals);
        renderInvestTypeChart(investByType, totalInvestYear);
        renderAnnualInvestSummary(investByType, totalInvestYear);
      }

      function renderSidebarHighlight() {
        const monthButtons = document.querySelectorAll('.month-btn');
        const btnAnnual = document.getElementById('btnAnnual');

        if (state.selectedMonth === null) btnAnnual.classList.add('bg-indigo-600','text-white','border-indigo-500'); else btnAnnual.classList.remove('bg-indigo-600','text-white','border-indigo-500');

        monthButtons.forEach((btn) => {
          const idx = parseInt(btn.getAttribute('data-month-index'), 10);
          btn.classList.remove('bg-gray-800','text-white');
          if (state.selectedMonth === idx) btn.classList.add('bg-gray-800','text-white');
        });
      }

      function renderDashboard(selectedMonth) {
        state.selectedMonth = selectedMonth;
        refreshYearFilterOptions();
        renderHeader();
        renderSidebarHighlight();

        const monthlyView = document.getElementById('monthlyView');
        const annualView = document.getElementById('annualView');

        if (state.selectedMonth === null) {
          monthlyView.classList.add('hidden');
          annualView.classList.remove('hidden');
          renderAnnualView();
        } else {
          annualView.classList.add('hidden');
          monthlyView.classList.remove('hidden');
          renderSummaryCards();
          renderBudgetRuleCards();
          renderCardsFaturas();
          renderTables();
        }
      }

      // ---------- CRUD (async onde necessário) ----------
      async function togglePaid(id) {
        const tx = state.transactions.find(t => t.id === id);
        if (!tx) return;
        const wasPaid = tx.paid;
        tx.paid = !tx.paid;
        
        // Immediate UI update for instant feedback
        renderTables();
        updatePaymentProgress();
        
        console.log(`togglePaid: Changing tx ${id} paid from ${wasPaid} to ${tx.paid}`);
        try {
          await saveTransactions();
          console.log(`togglePaid: saveTransactions completed successfully for tx ${id}`);
        } catch (error) {
          console.error(`togglePaid: Error saving transaction ${id}:`, error);
          showToast('Erro ao salvar alteração. Verifique a conexão.', 'error');
          // Revert the change if save failed
          tx.paid = wasPaid;
          renderTables();
          updatePaymentProgress();
          return;
        }
        const isReceita = tx.category === 'receita';
        showToast(
          wasPaid 
            ? (isReceita ? 'Marcado como não recebido' : 'Marcado como não pago')
            : (isReceita ? 'Marcado como recebido' : 'Marcado como pago'),
          'success'
        );
      }

      async function toggleAportado(id) {
        const tx = state.transactions.find(t => t.id === id);
        if (!tx) return;
        const wasAportado = tx.aportado;
        tx.aportado = !tx.aportado;
        
        // Immediate UI update for instant feedback
        renderTables();
        updatePaymentProgress();

        try {
          await saveTransactions();
        } catch (error) {
          console.error("toggleAportado: Error saving transaction:", error);
          showToast('Erro ao salvar alteração. Verifique a conexão.', 'error');
          tx.aportado = wasAportado;
          renderTables();
          updatePaymentProgress();
          return;
        }
        showToast(
          wasAportado ? 'Marcado como não aportado' : 'Marcado como aportado',
          'success'
        );
      }

      async function toggleInvoiceStatusForSelectedMonth(card) {
        const year = getYearForSelectedMonth();
        const m = state.selectedMonth;
        const key = keyInvoice(year, m, card);
        const wasPaid = state.invoicesPaid[key];
        state.invoicesPaid[key] = !state.invoicesPaid[key];
        
        // Immediate UI update for instant feedback
        renderCardsFaturas();
        updatePaymentProgress();
        
        console.log(`toggleInvoiceStatus: Changing invoice ${key} from ${wasPaid} to ${state.invoicesPaid[key]}`);
        try {
          await saveInvoices();
          console.log(`toggleInvoiceStatus: saveInvoices completed successfully for ${key}`);
        } catch (error) {
          console.error(`toggleInvoiceStatus: Error saving invoice ${key}:`, error);
          showToast('Erro ao salvar fatura. Verifique a conexão.', 'error');
          // Revert the change if save failed
          state.invoicesPaid[key] = wasPaid;
          renderCardsFaturas();
          updatePaymentProgress();
          return;
        }
        showToast(
          wasPaid ? 'Fatura marcada como não paga' : 'Fatura marcada como paga',
          'success'
        );
      }

      // Nota: a antiga função deleteTransaction(id) foi mantida mas a chamada direta foi substituída
      async function deleteTransactionById(id) {
        const previous = [...state.transactions];
        state.transactions = state.transactions.filter((t) => t.id !== id);
        try {
          await runWithRollback(
            async () => {
              await deleteDoc(doc(db, "transactions", id));
              const backupOk = updateLocalBackup();
              if (!backupOk) throw new Error("Falha ao atualizar backup local após excluir transação");
            },
            () => { state.transactions = previous; }
          );
        } catch (error) {
          console.error(`Erro ao apagar transação ${id} no Firestore`, error);
        }
        renderDashboard(state.selectedMonth);
      }

      async function deleteTransactionsByGroup(groupId) {
        const previous = [...state.transactions];
        const idsToDelete = state.transactions
          .filter((t) => t.groupId === groupId)
          .map((t) => t.id);
        state.transactions = state.transactions.filter((t) => t.groupId !== groupId);
        try {
          await runWithRollback(
            async () => {
              await Promise.all(idsToDelete.map((id) => deleteDoc(doc(db, "transactions", id))));
              const backupOk = updateLocalBackup();
              if (!backupOk) throw new Error("Falha ao atualizar backup local após excluir grupo");
            },
            () => { state.transactions = previous; }
          );
        } catch (error) {
          console.error(`Erro ao apagar grupo ${groupId} no Firestore`, error);
        }
        renderDashboard(state.selectedMonth);
      }

    async function addTransaction({
  description,
  value,
  date,
  category,
  subCategory,
  isCreditCard,
  card,
  parcelas,
  paymentMethod,
  aportado,
  extraLazer
}) {
  const baseDate = new Date(date);
  if (isNaN(baseDate.getTime())) return;

  const total = Number(value) || 0;

  let nParcelas = 1;

  // ✅ Parcelamento vale para CARTÃO e BOLETO
  if ((isCreditCard || paymentMethod === 'boleto') && category !== 'fixa') {
    nParcelas = Math.max(1, Math.floor(parcelas || 1));
  }

  // =========================
  // DESPESA FIXA (mensal)
  // =========================
  if (category === 'fixa') {
    // Despesas fixas continuam para anos futuros (próximos 12 meses)
    const groupId = generateId();
    
    for (let i = 0; i < 12; i++) {
      const d = new Date(baseDate);
      d.setMonth(d.getMonth() + i);

        state.transactions.push({
          id: generateId(),
          description,
          value: total,
          date: d.toISOString(),
        category,
        subCategory,
        isCreditCard,
        card: isCreditCard ? card : null,
          parcelas: 12,
          parcelaIndex: i + 1,
          paymentMethod,
          groupId: groupId,
          paid: false,
          aportado: false,
          extraLazer: category !== 'investimento' ? !!extraLazer : false
        });
      }
    }

  // =========================
  // LANÇAMENTO ÚNICO
  // =========================
  else if (nParcelas === 1) {
    state.transactions.push({
      id: generateId(),
      description,
      value: total,
      date: baseDate.toISOString(),
      category,
      subCategory,
      isCreditCard,
      card: isCreditCard ? card : null,
      parcelas: 1,
      parcelaIndex: 1,
      paymentMethod,
      groupId: null,
      paid: false,
      aportado: category === 'investimento' ? !!aportado : false,
      extraLazer: category !== 'investimento' ? !!extraLazer : false
    });
  }

  // =========================
  // PARCELADO (CARTÃO OU BOLETO)
  // =========================
  else {
    const totalCents = Math.round(total * 100);
    const baseCents = Math.floor(totalCents / nParcelas);
    const remainder = totalCents - baseCents * nParcelas;
    const groupId = generateId();

    for (let i = 0; i < nParcelas; i++) {
      const cents = baseCents + (i < remainder ? 1 : 0);
      const d = new Date(baseDate);
      d.setMonth(d.getMonth() + i);

      state.transactions.push({
        id: generateId(),
        description: `${description} (${i + 1}/${nParcelas})`,
        value: cents / 100,
        date: d.toISOString(),
        category,
        subCategory,
        isCreditCard,
        card: isCreditCard ? card : null,
        parcelas: nParcelas,
        parcelaIndex: i + 1,
        paymentMethod: paymentMethod, // Preserve the actual payment method
        groupId,
        paid: false,
        aportado: category === 'investimento' ? !!aportado : false,
        extraLazer: category !== 'investimento' ? !!extraLazer : false
      });
    }
  }

  // Render immediately to show optimistic UI update
  renderDashboard(state.selectedMonth);
  
  // Save in background
  try {
    await saveTransactions();
    console.log('✅ Transação salva com sucesso');
  } catch (error) {
    console.error('❌ Erro ao salvar transação:', error);
    showToast('Erro ao salvar. Os dados podem não persistir.', 'error');
  }
}


      // ---------- Modal edição ----------
      function openEditModal(id) {
        const tx = state.transactions.find((t) => t.id === id);
        if (!tx) return;
        state.editingId = id;
        state.editingMode = 'single';
        state.editingGroupId = tx.groupId || null;

        const modal = document.getElementById('editModal');
        modal.classList.remove('hidden'); modal.classList.add('flex');

        document.getElementById('editDesc').value = tx.description || '';
        document.getElementById('editValor').value = Number(tx.value || 0);
        document.getElementById('editData').value = new Date(tx.date).toISOString().slice(0, 10);

        const mainCatSelect = document.getElementById('editMainCategory');
        mainCatSelect.value = tx.category || 'receita';
        populateEditSubcategories(tx.category || 'receita', tx.subCategory || null);

        const paymentContainer = document.getElementById('editPaymentContainer');
        const editIsCartao = document.getElementById('editIsCartao');
        const editCartaoFields = document.getElementById('editCartaoFields');
        const editCartao = document.getElementById('editCartao');
        const editTambemLazer = document.getElementById('editTambemLazer');

        if (tx.category === 'receita') {
          paymentContainer.classList.add('hidden'); editIsCartao.checked = false; editCartaoFields.classList.add('hidden');
        } else {
          paymentContainer.classList.remove('hidden');
          // Check if it's a credit card transaction (both isCreditCard flag and paymentMethod)
          const isCard = (tx.isCreditCard || tx.paymentMethod === 'cartao');
          editIsCartao.checked = isCard;
          if (isCard) { editCartaoFields.classList.remove('hidden'); editCartao.value = tx.card || 'caixa'; }
          else editCartaoFields.classList.add('hidden');
        }

        if (editTambemLazer) editTambemLazer.checked = !!tx.extraLazer;

        const scopeBlock = document.getElementById('editParcelScope');
        const btnSingle = document.getElementById('btnScopeSingle');
        const btnAll = document.getElementById('btnScopeAll');

        // Check if this is an installment transaction (credit card or boleto)
        // Check for parcelas > 1 AND groupId AND (credit card OR boleto payment)
        console.log('Edit Modal - Transaction data:', {
          id: tx.id,
          parcelas: tx.parcelas,
          groupId: tx.groupId,
          isCreditCard: tx.isCreditCard,
          paymentMethod: tx.paymentMethod
        });
        
        const isParceladoSerie =
  tx.parcelas && tx.parcelas > 1 &&
  tx.groupId &&
  (tx.isCreditCard || 
   tx.paymentMethod === 'boleto' || 
   tx.paymentMethod === 'Boleto' ||
   tx.paymentMethod === 'cartao' ||
   tx.category === 'fixa');  // Incluir despesas fixas com parcelas
   
        console.log('Edit Modal - isParceladoSerie:', isParceladoSerie);

if (isParceladoSerie) {
  scopeBlock.classList.remove('hidden');
  state.editingMode = 'single';

  btnSingle.classList.add('bg-indigo-50','text-indigo-700','border-indigo-200');
  btnSingle.classList.remove('bg-gray-100','text-gray-600','border-gray-200');

  btnAll.classList.add('bg-gray-100','text-gray-600','border-gray-200');
  btnAll.classList.remove('bg-indigo-50','text-indigo-700','border-indigo-200');
  
  // Set current parcelas number
  const editParcelasInput = document.getElementById('editParcelas');
  if (editParcelasInput) {
    editParcelasInput.value = tx.parcelas || 1;
  }
  
  const previewBox = document.getElementById('editParcelPreview');
  const previewList = document.getElementById('editParcelPreviewList');

  if (previewBox && previewList) {
    previewList.innerHTML = '';
    buildParcelPreview(tx.groupId).forEach(html => {
      const li = document.createElement('li');
      li.innerHTML = html;
      li.className = 'text-indigo-800';
      previewList.appendChild(li);
    });
    previewBox.classList.add('hidden'); // Hidden by default, shows when parcelas changes
  }

} else {
  scopeBlock.classList.add('hidden');
  state.editingMode = 'single';
  const previewBox = document.getElementById('editParcelPreview');
if (previewBox) previewBox.classList.add('hidden');

}
      }

      // Function to preview new installment distribution
      function previewNewInstallments() {
        const tx = state.transactions.find((t) => t.id === state.editingId);
        if (!tx || !tx.groupId) return;
        
        const newParcelas = parseInt(document.getElementById('editParcelas').value) || 1;
        const currentParcelas = tx.parcelas || 1;
        
        // Only show preview if number changed
        if (newParcelas === currentParcelas) {
          document.getElementById('editParcelPreview').classList.add('hidden');
          return;
        }
        
        const totalValue = document.getElementById('editValor').value || 0;
        const baseDate = new Date(document.getElementById('editData').value);
        if (isNaN(baseDate.getTime())) return;
        
        const previewBox = document.getElementById('editParcelPreview');
        const previewList = document.getElementById('editParcelPreviewList');
        
        if (!previewBox || !previewList) return;
        
        // Calculate new distribution
        const totalCents = Math.round(totalValue * 100);
        const baseCents = Math.floor(totalCents / newParcelas);
        const remainder = totalCents - baseCents * newParcelas;
        
        previewList.innerHTML = '';
        
        for (let i = 0; i < newParcelas; i++) {
          const cents = baseCents + (i < remainder ? 1 : 0);
          const d = new Date(baseDate);
          d.setMonth(d.getMonth() + i);
          
          const monthLabel = `${MONTH_NAMES[d.getMonth()]}/${d.getFullYear()}`;
          const valueLabel = formatCurrency(cents / 100);
          
          const li = document.createElement('li');
          li.innerHTML = `<span class="flex items-center gap-2"><i class="fa-regular fa-calendar text-indigo-600"></i> ${monthLabel} — ${valueLabel} <span class="font-semibold">(${i + 1}/${newParcelas})</span></span>`;
          li.className = 'text-indigo-800';
          previewList.appendChild(li);
        }
        
        previewBox.classList.remove('hidden');
      }

      function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.add('hidden'); modal.classList.remove('flex');
        state.editingId = null; state.editingGroupId = null; state.editingMode = 'single';
      }

      // ---------- Modal exclusão ----------
      function openDeleteModal(id) {
        const tx = state.transactions.find((t) => t.id === id);
        if (!tx) return;
        state.deletingId = id;
        state.deletingGroupId = tx.groupId || null;
        state.deletingMode = 'single';

        const modal = document.getElementById('deleteModal');
        const scopeBlock = document.getElementById('deleteScopeBlock');
        const deleteSingleText = document.getElementById('deleteSingleText');

        // Exibir bloco de escopo somente se fizer parte de um grupo parcelado
        console.log('Delete Modal - Transaction data:', {
          id: tx.id,
          parcelas: tx.parcelas,
          groupId: tx.groupId,
          isCreditCard: tx.isCreditCard,
          paymentMethod: tx.paymentMethod
        });
        
       const isParceladoSerie =
  tx.parcelas && tx.parcelas > 1 &&
  tx.groupId &&
  (tx.isCreditCard || 
   tx.paymentMethod === 'boleto' || 
   tx.paymentMethod === 'Boleto' || 
   tx.paymentMethod === 'cartao' ||
   tx.category === 'fixa');  // Incluir despesas fixas com parcelas
  
        console.log('Delete Modal - isParceladoSerie:', isParceladoSerie);

if (isParceladoSerie) {
  const previewBox = document.getElementById('deleteParcelPreview');
const previewList = document.getElementById('deleteParcelPreviewList');

if (isParceladoSerie && previewBox && previewList) {
  previewList.innerHTML = '';
  buildParcelPreview(tx.groupId).forEach(html => {
    const li = document.createElement('li');
    li.innerHTML = html;
    li.className = 'text-red-800';
    previewList.appendChild(li);
  });
  previewBox.classList.remove('hidden');
} else if (previewBox) {
  previewBox.classList.add('hidden');
}

  scopeBlock.classList.remove('hidden');
  deleteSingleText.textContent =
    'Você pode excluir apenas esta parcela ou todas as parcelas da compra parcelada.';

  document.getElementById('btnDeleteSingle')
    .classList.add('bg-indigo-50','text-indigo-600','border-indigo-200');
  document.getElementById('btnDeleteSingle')
    .classList.remove('bg-gray-100','text-gray-600','border-gray-200');

  document.getElementById('btnDeleteAll')
    .classList.add('bg-gray-100','text-gray-600','border-gray-200');
  document.getElementById('btnDeleteAll')
    .classList.remove('bg-indigo-50','text-indigo-600','border-indigo-200');
} else {
  scopeBlock.classList.add('hidden');
  deleteSingleText.textContent =
    'Ao confirmar, este lançamento será removido permanentemente.';
}


        modal.classList.remove('hidden'); modal.classList.add('flex');
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden'); modal.classList.remove('flex');
        state.deletingId = null; state.deletingGroupId = null; state.deletingMode = 'single';
      }

      async function performDelete() {
        if (!state.deletingId) { closeDeleteModal(); return; }

        try {
          if (state.deletingMode === 'all' && state.deletingGroupId) {
            await deleteTransactionsByGroup(state.deletingGroupId);
            showToast('Todas as parcelas foram excluídas com sucesso', 'success');
          } else {
            // single
            await deleteTransactionById(state.deletingId);
            showToast('Lançamento excluído com sucesso', 'success');
          }
        } catch (error) {
          showToast('Erro ao excluir lançamento', 'error');
          console.error('Error deleting transaction:', error);
        }
        closeDeleteModal();
      }

      // ---------- EVENTOS e inicialização ----------
      // Table filtering function
      function setupTableFilters() {
        document.querySelectorAll('.table-filter').forEach(input => {
          input.addEventListener('input', function() {
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const columnIndex = parseInt(this.getAttribute('data-column'));
            const filterValue = this.value.toLowerCase().trim();
            
            // Update visual indicators for this input
            const filterCell = this.closest('.filter-cell');
            const filterIcon = filterCell ? filterCell.querySelector('.filter-indicator') : null;
            
            if (filterValue) {
              this.classList.add('active');
              if (filterIcon) filterIcon.style.display = 'block';
            } else {
              this.classList.remove('active');
              if (filterIcon) filterIcon.style.display = 'none';
            }
            
            // Get all filter inputs for this table
            const filterInputs = table.querySelectorAll('.table-filter');
            const filters = Array.from(filterInputs).map(input => ({
              column: parseInt(input.getAttribute('data-column')),
              value: input.value.toLowerCase().trim()
            }));
            
            // Check if any filter is active
            const hasActiveFilters = filters.some(f => f.value);
            
            // Update clear filters button visibility
            const clearBtn = document.querySelector(`[data-table="${table.id}"]`);
            if (clearBtn) {
              if (hasActiveFilters) {
                clearBtn.classList.add('visible');
              } else {
                clearBtn.classList.remove('visible');
              }
            }
            
            rows.forEach(row => {
              // Skip "no data" rows
              if (row.querySelector('td[colspan]')) {
                return;
              }
              
              const cells = row.querySelectorAll('td');
              let showRow = true;
              
              // Check all active filters
              filters.forEach(filter => {
                if (filter.value && filter.column < cells.length) {
                  const cellText = cells[filter.column].textContent.toLowerCase().trim();
                  if (!cellText.includes(filter.value)) {
                    showRow = false;
                  }
                }
              });
              
              row.style.display = showRow ? '' : 'none';
            });
          });
        });
        
        // Setup clear filters buttons
        document.querySelectorAll('.clear-filters-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table');
            const table = document.getElementById(tableId);
            if (!table) return;
            
            // Clear all filter inputs in this table
            const filterInputs = table.querySelectorAll('.table-filter');
            filterInputs.forEach(input => {
              input.value = '';
              input.classList.remove('active');
              
              const filterCell = input.closest('.filter-cell');
              const filterIcon = filterCell ? filterCell.querySelector('.filter-indicator') : null;
              if (filterIcon) filterIcon.style.display = 'none';
            });
            
            // Show all rows
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
              row.style.display = '';
            });
            
            // Hide the clear button
            this.classList.remove('visible');
          });
        });
      }

      // Table sorting function
      function setupTableSorting() {
        document.querySelectorAll('.sortable').forEach(header => {
          header.addEventListener('click', function() {
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const columnIndex = parseInt(this.getAttribute('data-column'));
            const dataType = this.getAttribute('data-type');
            
            // Determine sort direction
            const currentDirection = this.classList.contains('asc') ? 'asc' : 
                                   this.classList.contains('desc') ? 'desc' : 'none';
            let newDirection = 'asc';
            
            if (currentDirection === 'none') {
              newDirection = 'asc';
            } else if (currentDirection === 'asc') {
              newDirection = 'desc';
            } else {
              newDirection = 'asc';
            }
            
            // Remove sorting classes from all headers in this table
            table.querySelectorAll('.sortable').forEach(h => {
              h.classList.remove('asc', 'desc');
            });
            
            // Add new sorting class
            this.classList.add(newDirection);
            
            // Get all rows (excluding empty state rows)
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => 
              !row.querySelector('td[colspan]')
            );
            
            // Sort rows
            rows.sort((rowA, rowB) => {
              const cellA = rowA.querySelectorAll('td')[columnIndex];
              const cellB = rowB.querySelectorAll('td')[columnIndex];
              
              if (!cellA || !cellB) return 0;
              
              let valA = cellA.textContent.trim();
              let valB = cellB.textContent.trim();
              
              let comparison = 0;
              
              if (dataType === 'number') {
                // Extract numeric value (remove currency symbols, etc.)
                const numA = parseFloat(valA.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                const numB = parseFloat(valB.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                comparison = numA - numB;
              } else if (dataType === 'date') {
                // Parse date in DD/MM/YYYY format
                const parseDate = (dateStr) => {
                  const parts = dateStr.split('/');
                  if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                  }
                  return new Date(dateStr);
                };
                const dateA = parseDate(valA);
                const dateB = parseDate(valB);
                comparison = dateA - dateB;
              } else {
                // Text comparison
                comparison = valA.toLowerCase().localeCompare(valB.toLowerCase());
              }
              
              return newDirection === 'asc' ? comparison : -comparison;
            });
            
            // Re-append rows in sorted order
            rows.forEach(row => tbody.appendChild(row));
            
            // Reapply zebra striping
            tbody.querySelectorAll('tr').forEach((row, index) => {
              if (!row.querySelector('td[colspan]')) {
                row.classList.remove('bg-white', 'bg-gray-50/50');
                row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50');
              }
            });
          });
        });
      }

      // Toast notification function
      function showToast(message, type = 'success', title = '') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: 'fa-circle-check',
          error: 'fa-circle-xmark',
          warning: 'fa-triangle-exclamation'
        };
        
        const titles = {
          success: title || 'Sucesso',
          error: title || 'Erro',
          warning: title || 'Atenção'
        };
        
        toast.innerHTML = `
          <i class="fa-solid ${icons[type]} toast-icon ${type}"></i>
          <div class="toast-content">
            <div class="toast-title">${titles[type]}</div>
            <div class="toast-message">${message}</div>
          </div>
          <i class="fa-solid fa-xmark toast-close"></i>
        `;
        
        container.appendChild(toast);
        
        // Close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        });
        
        // Show animation
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      function setupEvents() {
        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        if (sidebarToggle && sidebar) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            sidebarToggle.classList.toggle('collapsed');
          });
        }
        
        document.querySelectorAll('.month-btn').forEach((btn) => {
          btn.addEventListener('click', () => renderDashboard(parseInt(btn.getAttribute('data-month-index'), 10)));
        });
        document.getElementById('btnAnnual').addEventListener('click', () => renderDashboard(null));

        const despCategoria = document.getElementById('despCategoria');

        const formaPagamentoSelect = document.getElementById('despFormaPagamento');
        if (formaPagamentoSelect) {
          formaPagamentoSelect.addEventListener('change', () => updateParcelVisibilityAndCard());
        }

        if (despCategoria) {
          despCategoria.addEventListener('change', () => {
            populateDespesaSubcategorias();
            updateParcelVisibilityAndCard();
          });
        }

        const formReceita = document.getElementById('formReceita');
        formReceita.addEventListener('submit', async (e) => {
          e.preventDefault();
          const description = document.getElementById('recDesc').value.trim();
          const rawValue = document.getElementById('recValor').value;
          const value = parseFloat(rawValue.toString().replace(',', '.'));
          const date = document.getElementById('recData').value;
          const subCategory = document.getElementById('recCategoria').value;
          if (!description || !date || isNaN(value)) return;

          try {
            await addTransaction({
              description,
              value,
              date,
              category: 'receita',
              subCategory,
              isCreditCard: false,
              card: null,
              parcelas: 1,
              paymentMethod: 'debito_pix'
            });

            showToast('Receita lançada com sucesso', 'success');
            formReceita.reset();
            const today = new Date().toISOString().slice(0, 10);
            const recDataInput = document.getElementById('recData');
            if (recDataInput && !recDataInput.value) recDataInput.value = today;
          } catch (error) {
            console.error('Erro ao lançar receita:', error);
            showToast('Erro ao salvar receita. Tente novamente.', 'error');
          }
        });

        const formDespesa = document.getElementById('formDespesa');
        formDespesa.addEventListener('submit', async (e) => {
          e.preventDefault();
          const description = document.getElementById('despDesc').value.trim();
          const rawValue = document.getElementById('despValor').value;
          const value = parseFloat(rawValue.toString().replace(',', '.'));
          const date = document.getElementById('despData').value;
          const category = document.getElementById('despCategoria').value;
        const subCategory = document.getElementById('despSubCategoria').value;
        const forma = document.getElementById('despFormaPagamento').value;
        const extraLazer = document.getElementById('despTambemLazer').checked;

          // Decidir se é pagamento via cartão
          const isCreditCard = forma === 'cartao';
const card = isCreditCard ? document.getElementById('despCartao').value : null;

// ✅ Parcelas valem para CARTÃO e BOLETO
let parcelas = 1;
if (forma === 'cartao' || forma === 'boleto') {
  parcelas = parseInt(document.getElementById('despParcelas').value || '1', 10);
}

          if (!description || !date || isNaN(value)) return;

          try {
            await addTransaction({
              description,
              value,
              date,
              category,
              subCategory,
              isCreditCard,
              card,
              parcelas,
              paymentMethod: isCreditCard ? 'cartao' : forma, // 'boleto' or 'debito_pix' or 'dinheiro'
              aportado: false, // sempre false vindo do formulário; o status pode ser alterado via tabela
              extraLazer
            });

            const categoryLabels = {
              'fixa': 'Despesa fixa',
              'variavel': 'Despesa variável',
              'investimento': 'Investimento'
            };
            showToast(`${categoryLabels[category] || 'Lançamento'} adicionado com sucesso`, 'success');
            
            formDespesa.reset();
            // esconder subseções pós-reset
            document.getElementById('despCartaoFields').classList.add('hidden');
            document.getElementById('despParcelasWrapper').classList.add('hidden');

            // repor datas para hoje caso precise
            const today = new Date().toISOString().slice(0, 10);
            const despDataInput = document.getElementById('despData');
            if (despDataInput && !despDataInput.value) despDataInput.value = today;
          } catch (error) {
            console.error('Erro ao lançar despesa/investimento:', error);
            showToast('Erro ao salvar lançamento. Tente novamente.', 'error');
          }

          // repopular subcategorias e visibilidade
          populateDespesaSubcategorias();
          updateParcelVisibilityAndCard();
        });

        document.querySelectorAll('.card-status-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const card = btn.getAttribute('data-card');
            toggleInvoiceStatusForSelectedMonth(card);
          });
        });

        const mainCatSelect = document.getElementById('editMainCategory');
        const editIsCartao = document.getElementById('editIsCartao');
        const editCartaoFields = document.getElementById('editCartaoFields');
        const paymentContainer = document.getElementById('editPaymentContainer');

        mainCatSelect.addEventListener('change', () => {
          const cat = mainCatSelect.value;
          populateEditSubcategories(cat, null);
          if (cat === 'receita') { paymentContainer.classList.add('hidden'); editIsCartao.checked = false; editCartaoFields.classList.add('hidden'); }
          else paymentContainer.classList.remove('hidden');
        });

        editIsCartao.addEventListener('change', () => { if (editIsCartao.checked) editCartaoFields.classList.remove('hidden'); else editCartaoFields.classList.add('hidden'); });

        document.getElementById('btnEditClose').addEventListener('click', closeEditModal);
        document.getElementById('btnEditCancel').addEventListener('click', closeEditModal);

        const btnScopeSingle = document.getElementById('btnScopeSingle');
        const btnScopeAll = document.getElementById('btnScopeAll');

        btnScopeSingle.addEventListener('click', () => {
          state.editingMode = 'single';
          btnScopeSingle.classList.add('bg-indigo-50','text-indigo-600','border-indigo-200');
          btnScopeSingle.classList.remove('bg-gray-100','text-gray-600','border-gray-200');
          btnScopeAll.classList.add('bg-gray-100','text-gray-600','border-gray-200');
          btnScopeAll.classList.remove('bg-indigo-50','text-indigo-600','border-indigo-200');
        });

        btnScopeAll.addEventListener('click', () => {
          state.editingMode = 'all';
          btnScopeAll.classList.add('bg-indigo-50','text-indigo-700','border-indigo-200');
          btnScopeAll.classList.remove('bg-gray-100','text-gray-600','border-gray-200');
          btnScopeSingle.classList.add('bg-gray-100','text-gray-600','border-gray-200');
          btnScopeSingle.classList.remove('bg-indigo-50','text-indigo-700','border-indigo-200');
        });

        // Event listener for parcelas input change
        const editParcelasInput = document.getElementById('editParcelas');
        if (editParcelasInput) {
          editParcelasInput.addEventListener('input', previewNewInstallments);
        }

        const formEdit = document.getElementById('formEdit');
        formEdit.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!state.editingId) return;
          const idx = state.transactions.findIndex((t) => t.id === state.editingId);
          if (idx === -1) return;

          const desc = document.getElementById('editDesc').value.trim();
          const rawValue = document.getElementById('editValor').value;
          const value = parseFloat(rawValue.toString().replace(',', '.'));
          const dateStr = document.getElementById('editData').value;
          const mainCat = document.getElementById('editMainCategory').value;
        const subCat = document.getElementById('editSubCategory').value;
        const extraLazer = document.getElementById('editTambemLazer')?.checked;
          if (!desc || !dateStr || isNaN(value)) return;

          const isCard = mainCat === 'receita' ? false : document.getElementById('editIsCartao').checked;
          const card = isCard ? document.getElementById('editCartao').value : null;
          const newDate = new Date(dateStr);
          if (isNaN(newDate.getTime())) return;

          const txClicked = state.transactions[idx];
          const oldClickedDate = new Date(txClicked.date);
          const delta = newDate.getTime() - oldClickedDate.getTime();
          
          // Check if parcelas number changed for installment transactions
          const newParcelas = parseInt(document.getElementById('editParcelas').value) || 1;
          const isParceladoSerie = txClicked.groupId && txClicked.parcelas > 1;
          const parcelasChanged = isParceladoSerie && newParcelas !== txClicked.parcelas;

          if (state.editingMode === 'all' && txClicked.groupId) {
            const groupId = txClicked.groupId;
            
            // If parcelas changed, delete old installments and create new ones
            if (parcelasChanged) {
              // Delete all installments in the group
              state.transactions = state.transactions.filter((t) => t.groupId !== groupId);
              
              // Create new installments with new distribution
              const totalCents = Math.round(value * 100);
              const baseCents = Math.floor(totalCents / newParcelas);
              const remainder = totalCents - baseCents * newParcelas;
              const newGroupId = generateId();
              const baseDesc = desc.replace(/\s*\(\d+\/\d+\)\s*$/, '');
              
              for (let i = 0; i < newParcelas; i++) {
                const cents = baseCents + (i < remainder ? 1 : 0);
                const d = new Date(newDate);
                d.setMonth(d.getMonth() + i);
                
                state.transactions.push({
                  id: generateId(),
                  description: `${baseDesc} (${i + 1}/${newParcelas})`,
                  value: cents / 100,
                  date: d.toISOString(),
                  category: mainCat,
                  subCategory: subCat || null,
                  isCreditCard: isCard,
                  card: card,
                  parcelas: newParcelas,
                  parcelaIndex: i + 1,
                  paymentMethod: txClicked.paymentMethod, // Preserve original payment method
                  groupId: newGroupId,
                  paid: false,
                  aportado: mainCat === 'investimento' ? false : false,
                  extraLazer: mainCat !== 'investimento' ? !!extraLazer : false
                });
              }
              
              showToast(`Parcelas atualizadas: ${txClicked.parcelas} → ${newParcelas}`, 'success');
            } else {
              // Normal update for all installments
              state.transactions.forEach((t) => {
                if (t.groupId === groupId) {
                  const baseDesc = desc.replace(/\s*\(\d+\/\d+\)\s*$/, '');
                  if (t.parcelas && t.parcelaIndex) t.description = `${baseDesc} (${t.parcelaIndex}/${t.parcelas})`;
                  else t.description = baseDesc;
                   t.category = mainCat; t.subCategory = subCat || null; t.isCreditCard = isCard; t.card = card;
                  t.extraLazer = mainCat !== 'investimento' ? !!extraLazer : false;
                  // Preserve paymentMethod if not changing to/from credit card
                  if (isCard) {
                    t.paymentMethod = 'cartao';
                  } else if (txClicked.paymentMethod === 'cartao') {
                    // Was credit card, now isn't - change to debito_pix
                    t.paymentMethod = 'debito_pix';
                  } else {
                    // Keep existing paymentMethod (like 'boleto', 'debito_pix', etc)
                    t.paymentMethod = txClicked.paymentMethod || 'debito_pix';
                  }
                  t.value = value;
                  const oldDate = new Date(t.date);
                  if (!isNaN(oldDate.getTime())) {
                    const shifted = new Date(oldDate.getTime() + delta);
                    t.date = shifted.toISOString();
                  }
                }
              });
              
              showToast('Todas as parcelas atualizadas com sucesso', 'success');
            }
          } else {
            txClicked.description = desc; txClicked.value = value; txClicked.date = newDate.toISOString();
            txClicked.category = mainCat; txClicked.subCategory = subCat || null; txClicked.isCreditCard = isCard; txClicked.card = card;
            txClicked.extraLazer = mainCat !== 'investimento' ? !!extraLazer : false;
            // Preserve paymentMethod if not changing to/from credit card
            if (isCard) {
            txClicked.paymentMethod = 'cartao';
          } else if (txClicked.paymentMethod === 'cartao') {
            // Was credit card, now isn't - change to debito_pix
            txClicked.paymentMethod = 'debito_pix';
          } else {
            // Keep existing paymentMethod (like 'boleto', 'debito_pix', etc)
            // No change needed - txClicked.paymentMethod stays as is
          }
          
          showToast('Lançamento atualizado com sucesso', 'success');
        }

          await saveTransactions();
          closeEditModal();
          renderDashboard(state.selectedMonth);
        });

        // Eventos do modal de exclusão
        document.getElementById('btnDeleteClose').addEventListener('click', closeDeleteModal);
        document.getElementById('btnDeleteCancel').addEventListener('click', closeDeleteModal);

        const btnDeleteSingle = document.getElementById('btnDeleteSingle');
        const btnDeleteAll = document.getElementById('btnDeleteAll');
        const btnDeleteConfirm = document.getElementById('btnDeleteConfirm');

        if (btnDeleteSingle) btnDeleteSingle.addEventListener('click', () => {
          state.deletingMode = 'single';
          btnDeleteSingle.classList.add('bg-indigo-50','text-indigo-600','border-indigo-200');
          btnDeleteSingle.classList.remove('bg-gray-100','text-gray-600','border-gray-200');
          btnDeleteAll.classList.add('bg-gray-100','text-gray-600','border-gray-200');
          btnDeleteAll.classList.remove('bg-indigo-50','text-indigo-600','border-indigo-200');
        });

        if (btnDeleteAll) btnDeleteAll.addEventListener('click', () => {
          state.deletingMode = 'all';
          btnDeleteAll.classList.add('bg-indigo-50','text-indigo-600','border-indigo-200');
          btnDeleteAll.classList.remove('bg-gray-100','text-gray-600','border-gray-200');
          btnDeleteSingle.classList.add('bg-gray-100','text-gray-600','border-gray-200');
          btnDeleteSingle.classList.remove('bg-indigo-50','text-indigo-600','border-indigo-200');
        });

        if (btnDeleteConfirm) btnDeleteConfirm.addEventListener('click', performDelete);

        const yearFilter = document.getElementById('yearFilter');
        if (yearFilter) yearFilter.addEventListener('change', () => { const val = yearFilter.value; state.selectedYear = val === 'all' ? 'all' : parseInt(val, 10); renderDashboard(state.selectedMonth); });

        const btnCsv = document.getElementById('btnExportCsv');
        const btnExcel = document.getElementById('btnExportExcel');
        if (btnCsv) btnCsv.addEventListener('click', () => exportAnnualSummary('csv'));
        if (btnExcel) btnExcel.addEventListener('click', () => exportAnnualSummary('xlsx'));

        const today = new Date().toISOString().slice(0, 10);
        const recDataInput = document.getElementById('recData');
        const despDataInput = document.getElementById('despData');
        if (recDataInput && !recDataInput.value) recDataInput.value = today;
        if (despDataInput && !despDataInput.value) despDataInput.value = today;

        populateDespesaSubcategorias();
        updateParcelVisibilityAndCard();
        setupTableFilters();
        setupTableSorting();
      }

      // Export CSV / Excel (gera CSV; para xlsx aqui usamos extensão .xlsx com conteúdo CSV — simples)
      function exportAnnualSummary(ext) {
        const { monthly, totals } = computeAnnualData();
        const { totalReceitasYear, totalDespesasYear, totalInvestYear, totalSaldoYear } = totals;
        const lines = [];
        lines.push('Mês;Receitas;Despesas;Investimentos;Saldo');
        monthly.forEach(mData => {
          function numStr(v) { return (v || 0).toFixed(2).replace('.', ','); }
          lines.push([ MONTH_NAMES[mData.monthIndex], numStr(mData.receitas), numStr(mData.despesas), numStr(mData.investimentos), numStr(mData.saldo) ].join(';'));
        });
        function numStr(v) { return (v || 0).toFixed(2).replace('.', ','); }
        lines.push([ 'Total', numStr(totalReceitasYear), numStr(totalDespesasYear), numStr(totalInvestYear), numStr(totalSaldoYear) ].join(';'));
        const csvContent = lines.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = ext === 'xlsx' ? 'resumo_anual.xlsx' : 'resumo_anual.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      async function init() {
        // Garantir que a página abra no mês e ano atuais
        state.selectedMonth = new Date().getMonth();
        state.selectedYear = new Date().getFullYear();
        console.log('Init: setting selectedMonth to', state.selectedMonth, 'and selectedYear to', state.selectedYear);
        
        await loadTransactions();
        await loadInvoices();
        refreshYearFilterOptions();
        setupEvents();
        renderDashboard(state.selectedMonth);
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
